<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Ristorante</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

<div id="login-overlay">
    <div id="login-box">
        <h2 style="color: var(--primary-color);">Area Riservata</h2>
        <p>Inserisci la password amministratore</p>
        <input type="password" id="admin-pass" placeholder="Password...">
        <button onclick="checkLogin()">ENTRA</button>
    </div>
</div>

<div class="container" id="admin-content" style="display:none;">
    <h1>Gestione Menu & Ordini</h1>
    
    <div class="menu-section" style="background: #fff; border-left: 5px solid var(--primary-color);">
        <h2 style="margin-top:0;">1. Imposta Menu del Giorno</h2>
        
        <div class="menu-grid">
            <h3>üçù Primi Piatti</h3>
            <textarea id="menu-primi" rows="3" placeholder="Es: Pasta al sugo..."></textarea>
            
            <h3>üçñ Secondi</h3>
            <textarea id="menu-secondi" rows="3" placeholder="Es: Cotoletta..."></textarea>
            
            <h3>ü•ó Contorni</h3>
            <textarea id="menu-contorni" rows="3" placeholder="Es: Insalata..."></textarea>
            
            <h3>üçï Pizze (Info testo)</h3>
            <textarea id="menu-pizze" rows="3" placeholder="Es: Margherita, Diavola..."></textarea>
        </div>

        <button onclick="salvaMenu()" style="margin-top:15px;">PUBBLICA MENU</button>
    </div>

    <hr>

    <h2>Ordini Ricevuti</h2>
    <div id="status-db" style="color:gray; font-size:0.9em; margin-bottom:15px;">Stato: In attesa di login...</div>
    
    <h3>ü•° ASPORTO</h3>
    <div id="lista-asporto"></div>

    <h3>üçΩÔ∏è TAVOLI</h3>
    <div id="lista-tavoli"></div>

    <button class="delete-btn" onclick="cancellaTutto()">üóëÔ∏è RESET GIORNATA (CANCELLA TUTTO)</button>
</div>

<script>
    const PASSWORD_ADMIN = "pizza123"; // <--- CAMBIA LA PASSWORD QUI SE VUOI

    // ***********************************************************
    // ‚ö†Ô∏è INCOLLA QUI SOTTO LA TUA CONFIGURAZIONE FIREBASE
    // NON CANCELLARE LE PARENTESI GRAFFE { }
    // ***********************************************************
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    let db;

    // Funzione di Login
    function checkLogin() {
        const pass = document.getElementById('admin-pass').value;
        if(pass === PASSWORD_ADMIN) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            avviaFirebase();
        } else {
            alert("Password errata");
        }
    }

    // Avvio Firebase solo dopo il login
    function avviaFirebase() {
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                document.getElementById('status-db').innerText = "Stato: Connesso. In attesa dati...";
                caricaDati();
            } catch (e) {
                alert("Errore Configurazione: " + e.message);
            }
        }
    }

    function caricaDati() {
        // 1. Carica Menu nelle caselle
        db.ref('menu').once('value', (s) => {
            const m = s.val();
            if(m && typeof m === 'object') {
                document.getElementById('menu-primi').value = m.primi || "";
                document.getElementById('menu-secondi').value = m.secondi || "";
                document.getElementById('menu-contorni').value = m.contorni || "";
                document.getElementById('menu-pizze').value = m.pizze || "";
            }
        });

        // 2. Ascolta gli Ordini
        db.ref('ordini').on('value', (snapshot) => {
            document.getElementById('status-db').innerText = "Stato: Dati ricevuti e aggiornati.";
            renderOrdini(snapshot.val());
        });
    }

    function renderOrdini(data) {
        const divAsporto = document.getElementById('lista-asporto');
        const divTavoli = document.getElementById('lista-tavoli');
        divAsporto.innerHTML = ""; divTavoli.innerHTML = "";

        if(!data) { 
            divAsporto.innerHTML = "<p style='color:#888;'>Nessun ordine presente.</p>"; 
            return; 
        }

        let gruppiTavoli = {};

        Object.values(data).forEach(ordine => {
            if (!ordine.items && !ordine.piatti) return; 

            // Gestione Piatti (Compatibilit√† vecchio/nuovo)
            let piattiHTML = "";
            if(ordine.items) {
                piattiHTML = ordine.items.map(i => `<span>‚Ä¢ <strong>${i.qty}x</strong> ${i.nome}</span>`).join("<br>");
            } else if (ordine.piatti) {
                piattiHTML = ordine.piatti.join(", "); 
            }

            // Gestione Telefono (Nuova funzione)
            const telefonoHTML = ordine.telefono 
                ? `<div style="margin-top:5px; font-size:0.9em;">üìû <a href="tel:${ordine.telefono}" style="color:var(--secondary-color); text-decoration:none; font-weight:bold;">${ordine.telefono}</a></div>` 
                : "";

            // Creazione Card HTML
            const htmlCard = `
                <div class="card" style="border-left: 5px solid ${ordine.tipo === 'asporto' ? '#28a745' : '#007bff'} !important;">
                    <div style="font-size:1.1em;"><strong>${ordine.cliente}</strong> <span style="font-size:0.9em; color:#666;">(${ordine.orario})</span></div>
                    ${telefonoHTML}
                    <div style="margin-top:8px; padding-top:8px; border-top:1px dashed #eee; color:#444;">${piattiHTML}</div>
                </div>`;

            if(ordine.tipo === 'asporto') {
                divAsporto.innerHTML += htmlCard;
            } else {
                const nomeTav = ordine.tavolo || "Sconosciuto";
                if(!gruppiTavoli[nomeTav]) {
                    gruppiTavoli[nomeTav] = [];
                }
                gruppiTavoli[nomeTav].push(htmlCard);
            }
        });

        // Stampa i Tavoli Raggruppati
        for (const [tavolo, cards] of Object.entries(gruppiTavoli)) {
            divTavoli.innerHTML += `
                <div class="tavolo-group">
                    <div class="tavolo-title">TAVOLO: ${tavolo}</div>
                    ${cards.join("")}
                </div>`;
        }
    }

    function salvaMenu() {
        const menuData = {
            primi: document.getElementById('menu-primi').value,
            secondi: document.getElementById('menu-secondi').value,
            contorni: document.getElementById('menu-contorni').value,
            pizze: document.getElementById('menu-pizze').value
        };
        db.ref('menu').set(menuData);
        alert("Menu Pubblicato con successo!");
    }

    function cancellaTutto() {
        if(confirm("ATTENZIONE: Stai per cancellare TUTTI gli ordini di oggi.\nVuoi procedere?")) {
            db.ref('ordini').remove();
            alert("Database pulito. Pronto per una nuova giornata.");
            location.reload();
        }
    }
</script>
</body>
</html>
