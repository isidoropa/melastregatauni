<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Ristorante</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #ff6b6b; --bg: #416058; --dark: #2d3436; --light: #fff; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--dark); }
        .container { max-width: 600px; margin: 0 auto; background: var(--light); padding: 30px; border-radius: 15px; }
        h1, h2, h3 { text-align: center; margin-bottom: 15px; }
        h1 { color: var(--primary); }
        
        input, textarea { width: 100%; padding: 12px; margin: 5px 0 15px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; }
        button { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1em; cursor: pointer; margin-top: 10px; }
        .delete-btn { background: #d63031; margin-top: 30px; }
        .logout-btn { background: #636e72; font-size: 0.9em; padding: 10px; margin-bottom: 20px; }
        
        .menu-section { border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid var(--primary); }
        .card { background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .tavolo-group { background: #fffdf2; border: 1px solid #ffeeba; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .tavolo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #eecd64; padding-bottom: 5px; }
        .tavolo-name { font-weight: 800; color: #e1b12c; text-transform: uppercase; font-size: 1.2em; }
        .tavolo-count { background: #2d3436; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }

        /* Stile per le note nell'ordine */
        .order-note {
            background: #ffeaa7; color: #d35400; padding: 8px; 
            border-radius: 6px; font-size: 0.9em; margin-top: 10px; font-style: italic;
            border-left: 3px solid #fdcb6e;
        }

        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(65, 96, 88, 0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        #login-box { background: white; padding: 40px; border-radius: 15px; width: 300px; text-align: center; }
        .error-msg { color: red; font-size: 0.9em; margin-top: 10px; display: none; }
    </style>
</head>
<body>

<div id="login-overlay">
    <div id="login-box">
        <h2 style="color:var(--primary)">Area Admin</h2>
        <input type="email" id="email" placeholder="Email Admin">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">ENTRA</button>
        <div id="login-error" class="error-msg">Credenziali sbagliate!</div>
    </div>
</div>

<div class="container" id="admin-content" style="display:none;">
    <button class="logout-btn" onclick="logout()">Esci</button>
    <h1>Gestione Ristorante</h1>
    
    <div class="menu-section">
        <h2>Imposta Menu</h2>
        <div class="menu-grid">
            <h3>üçù Primi</h3> <textarea id="menu-primi" rows="2"></textarea>
            <h3>üçñ Secondi</h3> <textarea id="menu-secondi" rows="2"></textarea>
            <h3>ü•ó Contorni</h3> <textarea id="menu-contorni" rows="2"></textarea>
            <h3 style="color:#27ae60;">ü•¨ Insalatone</h3> <textarea id="menu-insalatone" rows="2" placeholder="Es. Insalata Greca..."></textarea>
            <h3>üçï Pizze (Info)</h3> <textarea id="menu-pizze" rows="2"></textarea>
        </div>
        <button onclick="salvaMenu()">PUBBLICA MENU</button>
    </div>

    <hr style="border:0; border-top:1px solid #eee; margin:30px 0;">

    <h2>Ordini in Arrivo</h2>
    <div id="status-db" style="text-align:center; color:gray; font-size:0.8em; margin-bottom:10px;">Connessione...</div>

    <h3>ü•° Asporto</h3>
    <div id="lista-asporto"></div>

    <h3>üçΩÔ∏è Tavoli</h3>
    <div id="lista-tavoli"></div>

    <button class="delete-btn" onclick="cancellaTutto()">üóëÔ∏è RESET GIORNATA</button>
</div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    auth.onAuthStateChanged((user) => {
        if (user) {
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            caricaDati();
        } else {
            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('admin-content').style.display = 'none';
        }
    });

    function login() {
        const email = document.getElementById('email').value;
        const pass = document.getElementById('password').value;
        auth.signInWithEmailAndPassword(email, pass).catch((error) => {
            document.getElementById('login-error').style.display = 'block';
        });
    }

    function logout() { auth.signOut().then(() => location.reload()); }

    function caricaDati() {
        db.ref('menu').once('value', (s) => {
            const m = s.val();
            if(m) {
                document.getElementById('menu-primi').value = m.primi || "";
                document.getElementById('menu-secondi').value = m.secondi || "";
                document.getElementById('menu-contorni').value = m.contorni || "";
                document.getElementById('menu-insalatone').value = m.insalatone || "";
                document.getElementById('menu-pizze').value = m.pizze || "";
            }
        });

        db.ref('ordini').on('value', (snapshot) => {
            document.getElementById('status-db').innerText = "Dati aggiornati in tempo reale.";
            renderOrdini(snapshot.val());
        });
    }

    function renderOrdini(data) {
        const divAsporto = document.getElementById('lista-asporto');
        const divTavoli = document.getElementById('lista-tavoli');
        divAsporto.innerHTML = ""; divTavoli.innerHTML = "";

        if(!data) { divAsporto.innerHTML = "<p style='color:#999; text-align:center;'>Nessun ordine.</p>"; return; }

        let gruppiTavoli = {};
        let contaPersonePerTavolo = {}; 

        Object.values(data).forEach(ordine => {
            if (!ordine.items && !ordine.piatti) return; 

            if (ordine.tipo === 'tavolo' && ordine.tavolo) {
                const nomeTav = ordine.tavolo;
                if (!contaPersonePerTavolo[nomeTav]) { contaPersonePerTavolo[nomeTav] = 0; }
                contaPersonePerTavolo[nomeTav] += (ordine.coperti || 0);
            }

            let piattiHTML = "";
            if(ordine.items) {
                piattiHTML = ordine.items.map(i => `<span>‚Ä¢ <strong>${i.qty}x</strong> ${i.nome}</span>`).join("<br>");
            } else if (ordine.piatti) {
                piattiHTML = ordine.piatti.join(", "); 
            }

            const telefonoHTML = ordine.telefono ? `<div style="margin-top:5px; font-size:0.9em;">üìû <a href="tel:${ordine.telefono}" style="font-weight:bold; color:#54a0ff;">${ordine.telefono}</a></div>` : "";
            const totaleHTML = ordine.totale ? `<div style="margin-top:10px; font-size:1.1em; color:#27ae60; border-top:1px solid #eee; padding-top:5px;">üí∞ <strong>Totale: ‚Ç¨ ${parseFloat(ordine.totale).toFixed(2)}</strong></div>` : "";
            const copertiOrdine = (ordine.tipo === 'tavolo' && ordine.coperti) ? `<span style="font-size:0.8em; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px;">üë§ +${ordine.coperti}</span>` : "";
            
            // --- MOSTRA NOTE SE PRESENTI ---
            const noteHTML = ordine.note ? `<div class="order-note">üìù Note: ${ordine.note}</div>` : "";

            const htmlCard = `
                <div class="card" style="border-left: 5px solid ${ordine.tipo === 'asporto' ? '#27ae60' : '#2980b9'} !important;">
                    <div style="font-size:1.1em;">
                        <strong>${ordine.cliente}</strong> 
                        <span style="font-size:0.9em; color:#666;">(${ordine.orario})</span>
                        ${copertiOrdine}
                    </div>
                    ${telefonoHTML}
                    <div style="margin-top:8px; color:#444;">${piattiHTML}</div>
                    ${noteHTML}
                    ${totaleHTML}
                </div>`;

            if(ordine.tipo === 'asporto') {
                divAsporto.innerHTML += htmlCard;
            } else {
                const nomeTav = ordine.tavolo || "Sconosciuto";
                if(!gruppiTavoli[nomeTav]) { gruppiTavoli[nomeTav] = []; }
                gruppiTavoli[nomeTav].push(htmlCard);
            }
        });

        for (const [tavolo, cards] of Object.entries(gruppiTavoli)) {
            const totalePersone = contaPersonePerTavolo[tavolo] || 0;
            divTavoli.innerHTML += `
                <div class="tavolo-group">
                    <div class="tavolo-header">
                        <span class="tavolo-name">TAVOLO: ${tavolo}</span>
                        <span class="tavolo-count">TOTALE POSTI: ${totalePersone} üë§</span>
                    </div>
                    ${cards.join("")}
                </div>`;
        }
    }

    function salvaMenu() {
        db.ref('menu').set({
            primi: document.getElementById('menu-primi').value,
            secondi: document.getElementById('menu-secondi').value,
            contorni: document.getElementById('menu-contorni').value,
            insalatone: document.getElementById('menu-insalatone').value,
            pizze: document.getElementById('menu-pizze').value
        });
        alert("Menu Pubblicato!");
    }

    function cancellaTutto() {
        if(confirm("Sei sicuro? Cancellerai TUTTI gli ordini.")) {
            db.ref('ordini').remove();
            location.reload();
        }
    }
</script>
</body>
</html>


