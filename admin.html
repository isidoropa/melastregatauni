<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --danger: #e74c3c;
            --purple: #9b59b6;
            --brand-green: #416058;
            --surface: #ffffff;
            --border: #e2e6ea;
        }

        body { font-family: 'Poppins', sans-serif; background: var(--brand-green); margin: 0; padding: 20px; color: #ffffff; }
        .container { max-width: 800px; margin: 0 auto; }

        h1, h2 { color: #ffffff; text-align: center; font-weight: 700; }
        h1 { margin-bottom: 20px; }
        h2 { font-size: 1.2em; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; margin-top: 30px; }

        .admin-panel, .menu-section, .card, #login-box, #bill-box, #edit-box {
            background: var(--surface); padding: 25px; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; border: none; color: #2d3436;
        }

        .admin-panel h2, #login-box h2, #bill-box h3, #edit-box h3 { color: var(--primary); border-bottom: 2px solid var(--border); }
        .menu-section h3 { color: var(--primary); }

        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #dfe6e9; border-radius: 8px; font-family: inherit; margin-bottom: 10px; box-sizing: border-box; background: #f9f9f9; }
        .price-input { width: 80px !important; display: inline-block; margin-left: 10px !important; text-align: center; border-color: var(--accent) !important; color: var(--accent); font-weight: bold; background: #fff; }

        button { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1em; margin-top: 10px; }
        button:hover { filter: brightness(95%); }

        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        .print-btn { background: #636e72; color: white; font-size: 0.85em; padding: 10px; }
        
        .global-actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .global-actions button { flex: 1; min-width: 150px; }
        
        #revenue-box { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; font-size: 1.3em; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3); margin-bottom: 20px; border: none; }

        /* CARD STYLES */
        .card { position: relative; border-left: 5px solid #bdc3c7; transition: all 0.3s; }
        .card-fresh { border-left-color: #f1c40f; background: #fffdf0; animation: pulse 2s infinite; }
        .card-completed { opacity: 0.5; background: #f0f0f0; border-left-color: #7f8c8d !important; }
        .card-completed div { text-decoration: line-through; }
        .card-completed .btn-check { background: #7f8c8d; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); } }

        .badge-new { position: absolute; top: 10px; right: 120px; background: #e74c3c; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.7em; font-weight: bold; }
        
        .card-actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; }
        .action-icon { width: 30px; height: 30px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); margin:0; padding:0; }
        .btn-delete-single { background: #fee; color: #c0392b; }
        .btn-check { background: #e8f5e9; color: #27ae60; font-size: 1.2em; }
        .btn-edit { background: #fff8e1; color: #f39c12; font-size: 1.1em; }

        .tavolo-group { border: 2px dashed #dfe6e9; background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 20px; color: #2d3436; }
        .tavolo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; flex-wrap: wrap; gap: 10px;}
        .tavolo-name { font-weight: 800; color: var(--primary); font-size: 1.1em; }
        .tavolo-info-btn { background: var(--primary); color: white; font-size: 0.9em; width: auto; padding: 8px 15px; margin: 0; display:flex; align-items:center; gap:5px; }

        .control-box { background: #f1f2f6; padding: 12px; border-radius: 8px; margin-top: 10px; display: flex; align-items: center; gap: 10px; font-weight: 600; color: #555; }
        .control-box input { width: 20px; margin: 0; }
        .panic-mode { background: #ffebeb; color: #c0392b; border: 1px solid #fab1a0; }

        #connection-status { position: fixed; top: 15px; right: 15px; z-index: 999; background: white; padding: 6px 15px; border-radius: 50px; font-size: 0.8em; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; color: #2d3436; }
        .led { width: 8px; height: 8px; border-radius: 50%; }
        .led-on { background: #2ecc71; box-shadow: 0 0 5px #2ecc71; }
        .led-off { background: #e74c3c; }

        #login-overlay, #bill-overlay, #edit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center; }
        #login-box, #bill-box, #edit-box { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 500px; position: relative; color: #2d3436; max-height: 90vh; overflow-y: auto; }
        
        .bill-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 8px 0; font-size: 0.95em; }
        .bill-total-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.2em; margin-top: 15px; border-top: 2px solid #2d3436; padding-top: 10px; color: var(--accent); }

        .edit-item-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .edit-item-qty { width: 60px; text-align: center; }
        .edit-item-select { flex: 1; }
        .btn-remove-item { background: #e74c3c; color: white; width: 30px; padding: 0; margin: 0; border-radius: 4px; }
    </style>
</head>
<body>

<div id="connection-status"><div id="status-led" class="led led-off"></div><span id="status-text">...</span></div>

<div id="login-overlay">
    <div id="login-box">
        <h2>üîí Accesso Admin</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-primary" onclick="login()">ENTRA</button>
        <div id="login-error" style="color:red; margin-top:10px; display:none;">Errore Login</div>
    </div>
</div>

<div id="bill-overlay" style="display:none;">
    <div id="bill-box">
        <button onclick="document.getElementById('bill-overlay').style.display='none'" style="position:absolute; top:10px; right:10px; width:30px; padding:5px; background:none; font-size:1.5em; color:#333; border:none; margin:0; cursor:pointer;">&times;</button>
        <h3 id="bill-title">Riepilogo Tavolo</h3>
        <div id="bill-content" style="margin-top:20px;"></div>
        <div class="bill-total-row">
            <span>TOTALE CONTO:</span>
            <span id="bill-total-value">‚Ç¨ 0,00</span>
        </div>
        <button class="print-btn" onclick="stampaConto()" style="background:#2d3436; margin-top:20px;">üñ®Ô∏è STAMPA CONTO</button>
    </div>
</div>

<div id="edit-overlay" style="display:none;">
    <div id="edit-box">
        <button onclick="document.getElementById('edit-overlay').style.display='none'" style="position:absolute; top:10px; right:10px; width:30px; padding:5px; background:none; font-size:1.5em; color:#333; border:none; margin:0; cursor:pointer;">&times;</button>
        <h3>‚úèÔ∏è Modifica Ordine</h3>
        <div id="edit-items-container" style="margin-top:20px;"></div>
        <label style="font-weight:bold; margin-top:20px; display:block;">Prezzo Totale (‚Ç¨):</label>
        <input type="number" id="edit-total-price" step="0.50" style="font-size:1.2em; color:#27ae60; font-weight:bold;">
        <button class="btn-success" onclick="salvaModifica()">üíæ SALVA MODIFICHE</button>
    </div>
</div>

<div class="container" id="admin-content" style="display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h1 style="margin:0;">Dashboard</h1>
        <button onclick="logout()" style="width:auto; background:rgba(255,255,255,0.2); color:white; padding:8px 15px; font-size:0.8em;">Esci</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h2 style="margin:0;">Ordini in Arrivo</h2>
        <div style="display:flex; align-items:center; gap:5px; font-size:0.9em; background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:20px;">
            <input type="checkbox" id="hide-completed" onchange="renderOrdini(globalRawData)" style="width:18px; height:18px; margin:0;">
            <label for="hide-completed" style="cursor:pointer; color:white;">Nascondi Completati</label>
        </div>
    </div>

    <div id="revenue-box">
        <div style="font-size:0.8em; opacity:0.9;">INCASSO OGGI</div>
        <strong id="total-revenue">‚Ç¨ 0,00</strong>
    </div>

    <button id="btn-audio" onclick="abilitaAudio()" style="background:#3498db; color:white; margin-bottom:20px;">üîî CLICCA PER ATTIVARE SUONO CAMPANELLA</button>
    
    <div class="admin-panel">
        <h2>Gestione Menu & Prezzi</h2>
        <div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center; border:1px solid #c3e6cb;">
            Prezzo Combo: <input type="number" id="price-combo" class="price-input" value="7.00"> ‚Ç¨
        </div>
        
        <h3>üçù Primi <input type="number" id="price-primi" class="price-input" value="5">‚Ç¨</h3> 
        <textarea id="menu-primi" rows="2"></textarea>
        
        <h3>üçñ Secondi <input type="number" id="price-secondi" class="price-input" value="5">‚Ç¨</h3> 
        <textarea id="menu-secondi" rows="2"></textarea>
        
        <h3>ü•ó Lista Contorni per Menu a Tendina</h3> 
        <p style="font-size:0.8em; margin:0; color:#666;">Scrivi un contorno per riga (es. Patatine)</p>
        <textarea id="menu-lista-contorni" rows="3" placeholder="Patatine&#10;Insalata&#10;Verdure"></textarea>
        
        <h3 style="color:var(--accent);">ü•¨ Insalatone <input type="number" id="price-insalatone" class="price-input" value="6">‚Ç¨</h3> 
        <textarea id="menu-insalatone" rows="2"></textarea>
        
        <h3>üçï Pizze <input type="number" id="price-pizze" class="price-input" value="7">‚Ç¨</h3> 
        <textarea id="menu-pizze" rows="2"></textarea>
        
        <div class="control-box"><input type="checkbox" id="pizze-soldout"> <label for="pizze-soldout">üö´ Pizze ESAURITE</label></div>
        <div class="control-box panic-mode"><input type="checkbox" id="blocca-ordini"> <label for="blocca-ordini">‚õîÔ∏è BLOCCA ORDINI (Panic)</label></div>
        <button class="btn-success" onclick="salvaMenu()">AGGIORNA MENU</button>
    </div>

    <div id="status-db" style="text-align:center; font-size:0.8em; color:rgba(255,255,255,0.7); margin-bottom:15px;">In attesa...</div>
    <h3>ü•° Asporto</h3> <div id="lista-asporto"></div>
    <h3>üçΩÔ∏è Tavoli</h3> <div id="lista-tavoli"></div>

    <div class="global-actions">
        <button class="btn-purple" onclick="fineGiornata()">üåô FINE GIORNATA</button>
        <button class="btn-success" onclick="scaricaExcel()">üì• EXCEL</button>
        <button class="btn-danger" onclick="cancellaTutto()">üóëÔ∏è RESET ORDINI</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };;

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let globalOrdersByTable = {}; 
    let globalRawData = {};
    let lastOrderCount = 0;
    let isFirstLoad = true;
    let currentEditKey = null;

    // --- NUOVO AUDIO CAMPANELLA (DLIN-DLON) ---
    let audioCtx = null;
    let audioEnabled = false;
    function abilitaAudio() {
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();
            audioCtx.resume().then(() => {
                audioEnabled = true; playSound();
                document.getElementById('btn-audio').style.display = 'none';
                alert("üîä Campanella Attivata!");
            });
        } catch(e) { alert("Errore Audio: " + e.message); }
    }
    
    function playSound() {
        if (!audioEnabled || !audioCtx) return;
        const t = audioCtx.currentTime;

        // Nota 1 (Alta)
        const osc1 = audioCtx.createOscillator();
        const gain1 = audioCtx.createGain();
        osc1.connect(gain1); gain1.connect(audioCtx.destination);
        osc1.type = 'sine'; osc1.frequency.setValueAtTime(880, t); // La5
        gain1.gain.setValueAtTime(0, t);
        gain1.gain.linearRampToValueAtTime(0.3, t + 0.05);
        gain1.gain.exponentialRampToValueAtTime(0.001, t + 1.5);
        osc1.start(t); osc1.stop(t + 1.5);

        // Nota 2 (Bassa - Terza minore sotto, per fare DLIN-DLON)
        const osc2 = audioCtx.createOscillator();
        const gain2 = audioCtx.createGain();
        osc2.connect(gain2); gain2.connect(audioCtx.destination);
        osc2.type = 'sine'; osc2.frequency.setValueAtTime(739.99, t + 0.3); // Fa#5
        gain2.gain.setValueAtTime(0, t + 0.3);
        gain2.gain.linearRampToValueAtTime(0.3, t + 0.35);
        gain2.gain.exponentialRampToValueAtTime(0.001, t + 2.0);
        osc2.start(t + 0.3); osc2.stop(t + 2.0);
    }

    db.ref(".info/connected").on("value", (snap) => {
        if (snap.val() === true) { document.getElementById('status-led').className = "led led-on"; document.getElementById('status-text').innerText = "Online"; document.getElementById('status-text').style.color = "#2ecc71"; } 
        else { document.getElementById('status-led').className = "led led-off"; document.getElementById('status-text').innerText = "Offline"; document.getElementById('status-text').style.color = "#e74c3c"; }
    });

    setInterval(() => { if(auth.currentUser) caricaDati(); }, 60000);
    auth.onAuthStateChanged((user) => { if (user) { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('admin-content').style.display = 'block'; caricaDati(); } else { document.getElementById('login-overlay').style.display = 'flex'; document.getElementById('admin-content').style.display = 'none'; } });

    function login() { const email = document.getElementById('email').value; const pass = document.getElementById('password').value; auth.signInWithEmailAndPassword(email, pass).catch((error) => { document.getElementById('login-error').style.display = 'block'; }); }
    function logout() { auth.signOut().then(() => location.reload()); }

    function caricaDati() {
        db.ref('menu').once('value', (s) => {
            const m = s.val();
            if(m) {
                document.getElementById('menu-primi').value = m.primi || "";
                document.getElementById('menu-secondi').value = m.secondi || "";
                document.getElementById('menu-lista-contorni').value = m.lista_contorni || "";
                document.getElementById('menu-insalatone').value = m.insalatone || "";
                document.getElementById('menu-pizze').value = m.pizze || "";
                document.getElementById('pizze-soldout').checked = m.pizze_esaurite || false;
                document.getElementById('blocca-ordini').checked = m.blocca_ordini || false;
                document.getElementById('price-primi').value = m.prezzo_primi || 5;
                document.getElementById('price-secondi').value = m.prezzo_secondi || 5;
                document.getElementById('price-insalatone').value = m.prezzo_insalatone || 6;
                document.getElementById('price-pizze').value = m.prezzo_pizze || 7;
                document.getElementById('price-combo').value = m.prezzo_combo || 7;
            }
        });
        db.ref('ordini').on('value', (snapshot) => { document.getElementById('status-db').innerText = "Ultimo agg: " + new Date().toLocaleTimeString(); renderOrdini(snapshot.val()); });
    }

    function renderOrdini(data) {
        const divAsporto = document.getElementById('lista-asporto'); const divTavoli = document.getElementById('lista-tavoli');
        divAsporto.innerHTML = ""; divTavoli.innerHTML = ""; 
        globalOrdersByTable = {}; globalRawData = data || {};

        if(!data) { 
            divAsporto.innerHTML = "<div style='text-align:center; color:rgba(255,255,255,0.6);'>Nessun ordine.</div>"; 
            divTavoli.innerHTML = "<div style='text-align:center; color:rgba(255,255,255,0.6);'>Nessun ordine.</div>"; 
            document.getElementById('total-revenue').innerText = "‚Ç¨ 0,00"; lastOrderCount = 0; return; 
        }

        let gruppiTavoli = {}; let contaPersonePerTavolo = {}; const now = Date.now(); let incassoTotale = 0; let currentOrderCount = 0;

        Object.entries(data).forEach(([key, ordine]) => {
            const hideCompleted = document.getElementById('hide-completed').checked;
            if (hideCompleted && ordine.completed) return;

            if (!ordine.items && !ordine.piatti) return; 
            currentOrderCount++; if(ordine.totale) { incassoTotale += parseFloat(ordine.totale); }

            if (ordine.tipo === 'tavolo' && ordine.tavolo) {
                const nomeTav = ordine.tavolo;
                if (!contaPersonePerTavolo[nomeTav]) { contaPersonePerTavolo[nomeTav] = 0; }
                contaPersonePerTavolo[nomeTav] += (ordine.coperti || 0);
                
                if (!globalOrdersByTable[nomeTav]) { globalOrdersByTable[nomeTav] = []; }
                globalOrdersByTable[nomeTav].push(ordine);
                if(!gruppiTavoli[nomeTav]) { gruppiTavoli[nomeTav] = []; }
            }

            let piattiHTML = ""; 
            if(ordine.items) { 
                piattiHTML = ordine.items.map(i => `<div style="margin-bottom:2px;">‚Ä¢ <strong>${i.qty}</strong> ${i.nome}</div>`).join(""); 
            }
            const telefonoHTML = ordine.telefono ? `<div style="font-size:0.85em; margin-top:5px; color:#3498db;">üìû ${ordine.telefono}</div>` : "";
            const totaleHTML = ordine.totale ? `<div style="margin-top:10px; font-weight:bold; color:#27ae60; border-top:1px dashed #eee; padding-top:5px;">‚Ç¨ ${parseFloat(ordine.totale).toFixed(2)}</div>` : "";
            const copertiOrdine = (ordine.tipo === 'tavolo' && ordine.coperti) ? `<span style="font-size:0.8em; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px; color:#333;">üë§ +${ordine.coperti}</span>` : "";
            const noteHTML = ordine.note ? `<div style="background:#fff3cd; color:#856404; padding:5px; border-radius:4px; font-size:0.85em; margin-top:5px;">‚ö†Ô∏è ${ordine.note}</div>` : "";
            const ordineString = encodeURIComponent(JSON.stringify(ordine));
            const diffMinutes = (now - (ordine.timestamp || 0)) / 1000 / 60;
            
            let cardClass = "card"; let badgeHTML = ""; let btnCheckText = "‚úî";
            if (ordine.completed) { cardClass += " card-completed"; } 
            else { if (diffMinutes < 5) { cardClass += " card-fresh"; badgeHTML = '<div class="badge-new">NEW</div>'; } else if (diffMinutes > 30) { cardClass += " card-old"; } }

            // SUONO CAMPANELLA SE C'√à UN NUOVO ORDINE
            if (!isFirstLoad && currentOrderCount > lastOrderCount) { playSound(); }

            const htmlCard = `
                <div class="${cardClass}" style="border-left-color: ${ordine.tipo === 'asporto' ? '#27ae60' : '#2980b9'};">
                    <div class="card-actions">
                        <button class="action-icon btn-edit" onclick="apriModifica('${key}')">‚úèÔ∏è</button>
                        <button class="action-icon btn-check" onclick="toggleCompletato('${key}', ${ordine.completed})">${btnCheckText}</button>
                        <button class="action-icon btn-delete-single" onclick="eliminaSingolo('${key}')">&times;</button>
                    </div>
                    ${badgeHTML}
                    <div style="font-size:1.05em; font-weight:bold;">${ordine.cliente} <span style="font-weight:normal; font-size:0.8em; color:#7f8c8d;">(${ordine.orario})</span> ${copertiOrdine}</div>
                    ${telefonoHTML}
                    <div style="margin-top:10px; font-size:0.95em;">${piattiHTML}</div>
                    ${noteHTML} ${totaleHTML}
                    <button class="print-btn" onclick="stampaOrdine('${ordineString}')">üñ®Ô∏è Stampa</button>
                </div>`;
            
            if(ordine.tipo === 'asporto') { divAsporto.innerHTML += htmlCard; } 
            else { gruppiTavoli[ordine.tavolo].push(htmlCard); }
        });

        document.getElementById('total-revenue').innerText = "‚Ç¨ " + incassoTotale.toFixed(2);
        
        lastOrderCount = currentOrderCount; 
        isFirstLoad = false;

        for (const [tavolo, cards] of Object.entries(gruppiTavoli)) {
            const totalePersone = contaPersonePerTavolo[tavolo] || 0;
            divTavoli.innerHTML += `<div class="tavolo-group"><div class="tavolo-header"><span class="tavolo-name">${tavolo}</span><div style="display:flex; align-items:center; gap:10px;"><button class="tavolo-info-btn" onclick="mostraContoTavolo('${tavolo}')">üí∞ CONTO TAVOLO</button><span style="font-size:0.9em; font-weight:bold; color:#555;">${totalePersone} Pers.</span></div></div>${cards.join("")}</div>`;
        }
        if(divAsporto.innerHTML === "") { divAsporto.innerHTML = "<div style='text-align:center; color:rgba(255,255,255,0.6);'>Nessun ordine.</div>"; }
        if(divTavoli.innerHTML === "") { divTavoli.innerHTML = "<div style='text-align:center; color:rgba(255,255,255,0.6);'>Nessun ordine.</div>"; }
    }

    function toggleCompletato(key, currentStatus) { db.ref('ordini/' + key).update({ completed: !currentStatus }); }

    // --- MODIFICA ORDINE ---
    function getMenuDropdownHTML(selectedName) {
        let allItems = [];
        ['menu-primi', 'menu-secondi', 'menu-insalatone', 'menu-pizze'].forEach(id => {
            const txt = document.getElementById(id).value;
            txt.split('\n').forEach(line => {
                const clean = line.replace('[X]', '').trim();
                if(clean) allItems.push(clean);
            });
        });
        allItems.sort();
        let html = ''; let found = false;
        const cleanSelected = selectedName.replace("PIZZA: ", "").split(" (con")[0].trim();
        
        allItems.forEach(dish => {
            const isSelected = dish === cleanSelected;
            if(isSelected) found = true;
            html += `<option value="${dish}" ${isSelected ? 'selected' : ''}>${dish}</option>`;
        });
        if(!found && cleanSelected) html = `<option value="${cleanSelected}" selected>${cleanSelected} (Attuale)</option>` + html;
        return `<select class="edit-item-select" onchange="ricalcolaTotaleModifica()">${html}</select>`;
    }

    function apriModifica(key) {
        currentEditKey = key;
        const ordine = globalRawData[key];
        const container = document.getElementById('edit-items-container');
        container.innerHTML = "";
        if (ordine.items) {
            ordine.items.forEach((item, index) => {
                const dropdown = getMenuDropdownHTML(item.nome);
                container.innerHTML += `<div class="edit-item-row" id="edit-item-${index}"><input type="number" class="edit-item-qty" value="${item.qty}" oninput="ricalcolaTotaleModifica()">${dropdown}<button class="btn-remove-item" onclick="{document.getElementById('edit-item-${index}').remove(); ricalcolaTotaleModifica();}">X</button></div>`;
            });
        }
        document.getElementById('edit-total-price').value = parseFloat(ordine.totale || 0).toFixed(2);
        document.getElementById('edit-overlay').style.display = 'flex';
    }

    function ricalcolaTotaleModifica() {
        let total = 0;
        document.querySelectorAll('.edit-item-row').forEach(row => {
            const qty = parseInt(row.querySelector('.edit-item-qty').value) || 0;
            const name = row.querySelector('.edit-item-select').value;
            const price = getPriceForItem(name); 
            total += (qty * price);
        });
        document.getElementById('edit-total-price').value = total.toFixed(2);
    }

    function salvaModifica() {
        const rows = document.querySelectorAll('.edit-item-row');
        let newItems = [];
        const menuPizze = document.getElementById('menu-pizze').value;
        rows.forEach(row => {
            const qty = parseInt(row.querySelector('.edit-item-qty').value);
            let nome = row.querySelector('.edit-item-select').value;
            if (menuPizze.includes(nome) && !nome.startsWith("PIZZA:")) nome = "PIZZA: " + nome;
            if (qty > 0 && nome.trim() !== "") newItems.push({ qty, nome });
        });
        const newTotal = parseFloat(document.getElementById('edit-total-price').value) || 0;
        db.ref('ordini/' + currentEditKey).update({ items: newItems, totale: newTotal }).then(() => { document.getElementById('edit-overlay').style.display = 'none'; });
    }

    // --- CONTO TAVOLO ---
    function getPriceForItem(name) {
        const mP = document.getElementById('menu-primi').value;
        const mS = document.getElementById('menu-secondi').value;
        const mI = document.getElementById('menu-insalatone').value;
        const mPiz = document.getElementById('menu-pizze').value;
        
        let price = 0; 
        const cN = name.replace("PIZZA: ", "").split(" (con")[0].trim();
        
        if (name.startsWith("PIZZA:")) price = parseFloat(document.getElementById('price-pizze').value)||0;
        else if (mP.includes(cN)) price = parseFloat(document.getElementById('price-primi').value)||0;
        else if (mS.includes(cN)) price = parseFloat(document.getElementById('price-secondi').value)||0;
        else if (mI.includes(cN)) price = parseFloat(document.getElementById('price-insalatone').value)||0;
        else if (mPiz.includes(cN)) price = parseFloat(document.getElementById('price-pizze').value)||0;
        
        return price;
    }

    let currentTableData = null;
    function mostraContoTavolo(tavolo) {
        const ordiniTavolo = globalOrdersByTable[tavolo]; if (!ordiniTavolo) return;
        let riepilogoItems = {}; let totaleRealeTavolo = 0; let totalePersone = 0;
        
        ordiniTavolo.forEach(ord => {
            totaleRealeTavolo += parseFloat(ord.totale || 0);
            totalePersone += parseInt(ord.coperti || 0);
            if (ord.items) {
                ord.items.forEach(item => {
                    const nome = item.nome; const qty = parseInt(item.qty);
                    if (!riepilogoItems[nome]) riepilogoItems[nome] = { qty: 0, price: getPriceForItem(nome) };
                    riepilogoItems[nome].qty += qty;
                });
            }
        });
        
        const container = document.getElementById('bill-content'); 
        container.innerHTML = `<div style="text-align:center; font-weight:bold; color:#555; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">üë• Totale Persone: ${totalePersone}</div>`;
        
        for (const [nome, data] of Object.entries(riepilogoItems)) {
            const lineTotal = data.qty * data.price;
            const priceStr = data.price > 0 ? `(‚Ç¨ ${data.price.toFixed(2)} cad.)` : "";
            container.innerHTML += `<div class="bill-item"><span><strong>${data.qty}x</strong> ${nome.replace("PIZZA: ","")} ${priceStr}</span><span>‚Ç¨ ${lineTotal.toFixed(2)}</span></div>`;
        }
        
        let htmlDiviso = `<div style="margin-top:10px; padding-top:10px; border-top:1px solid #eee; font-size:0.9em; color:#666; display:flex; align-items:center; gap:10px;"><span>‚ûó Diviso</span><input type="number" id="split-num" value="${totalePersone > 0 ? totalePersone : 1}" min="1" style="width:50px; padding:5px; text-align:center;" oninput="calcolaDiviso(${totaleRealeTavolo})">persone = <strong id="split-res" style="color:#2c3e50;">‚Ç¨ ${totaleRealeTavolo.toFixed(2)}</strong> a testa</div>`;
        
        document.getElementById('bill-title').innerText = "Conto Tavolo: " + tavolo;
        document.getElementById('bill-total-value').innerText = "‚Ç¨ " + totaleRealeTavolo.toFixed(2);
        container.innerHTML += htmlDiviso;
        
        setTimeout(() => calcolaDiviso(totaleRealeTavolo), 100);

        currentTableData = { tavolo, items: riepilogoItems, totale: totaleRealeTavolo, persone: totalePersone };
        document.getElementById('bill-overlay').style.display = 'flex';
    }

    function calcolaDiviso(totale) {
        const persone = parseInt(document.getElementById('split-num').value) || 1;
        const risultato = totale / persone;
        document.getElementById('split-res').innerText = "‚Ç¨ " + risultato.toFixed(2);
    }

    function stampaConto() {
        if(!currentTableData) return;
        let c = `<div style="font-family:monospace;width:300px;padding:10px;"><h3 style="text-align:center;margin:0">Mela Stregata</h3><p style="text-align:center;">CONTO TAVOLO: ${currentTableData.tavolo}</p><p style="text-align:center;">Persone: ${currentTableData.persone}</p><hr><ul style="padding-left:0;list-style:none;">`;
        for (const [nome, data] of Object.entries(currentTableData.items)) {
            const lineTotal = data.qty * data.price;
            c += `<li style="display:flex;justify-content:space-between;"><span>${data.qty}x ${nome.replace("PIZZA: ","")}</span> <span>‚Ç¨ ${lineTotal.toFixed(2)}</span></li>`;
        }
        c += `</ul><hr><h3 style="text-align:right">TOTALE: ‚Ç¨ ${currentTableData.totale.toFixed(2)}</h3></div>`;
        const w = window.open('','','height=600,width=400'); w.document.write('<html><body>'+c+'</body></html>'); w.document.close(); w.focus(); setTimeout(()=>{w.print();w.close()},500);
    }

    function fineGiornata() {
        if(!confirm("‚ö†Ô∏è ATTENZIONE: Cancello Primi e Secondi per domani.\n\nProcedere?")) return;
        db.ref('menu').update({ primi: "", secondi: "", pizze_esaurite: true, blocca_ordini: false });
        alert("‚úÖ Giornata chiusa! Primi e Secondi svuotati."); location.reload();
    }

    function stampaOrdine(ordineString) {
        const ordine = JSON.parse(decodeURIComponent(ordineString));
        let c = `<div style="font-family:monospace;width:300px;padding:10px;"><h3 style="text-align:center;margin:0">Mela Stregata</h3><p style="text-align:center;">${ordine.orario}</p><hr><p><strong>${ordine.cliente}</strong> (${ordine.telefono})</p><p>${ordine.tipo.toUpperCase()} ${ordine.tavolo || ''}</p><hr><ul style="padding-left:15px;">`;
        ordine.items.forEach(i => { c += `<li>${i.qty} x ${i.nome}</li>`; });
        c += `</ul>`; if(ordine.note) c+=`<p>NOTE: ${ordine.note}</p>`;
        c += `<hr><h3 style="text-align:right">TOT: ‚Ç¨ ${parseFloat(ordine.totale).toFixed(2)}</h3></div>`;
        const w = window.open('','','height=600,width=400'); w.document.write('<html><body>'+c+'</body></html>'); w.document.close(); w.focus(); setTimeout(()=>{w.print();w.close()},500);
    }

    function eliminaSingolo(id) { if(confirm("Eliminare ordine?")) { db.ref('ordini/' + id).remove(); } }
    function scaricaExcel() {
        if (Object.keys(globalRawData).length === 0) { alert("Nessun dato."); return; }
        let c = "data:text/csv;charset=utf-8,\uFEFFOrario,Cliente,Telefono,Tipo,Totale,Dettagli\n";
        Object.values(globalRawData).forEach(o => { if(!o.items)return; c += [o.orario, o.cliente, o.telefono, o.tipo, (o.totale||0).toFixed(2), `"${o.items.map(i=>`${i.qty} ${i.nome}`).join(", ")}"`].join(",") + "\n"; });
        const l = document.createElement("a"); l.setAttribute("href", encodeURI(c)); l.setAttribute("download", "report.csv"); document.body.appendChild(l); l.click(); document.body.removeChild(l);
    }

    function salvaMenu() {
        db.ref('menu').update({
            primi: document.getElementById('menu-primi').value,
            secondi: document.getElementById('menu-secondi').value,
            // Lista contorni
            lista_contorni: document.getElementById('menu-lista-contorni').value,
            insalatone: document.getElementById('menu-insalatone').value,
            pizze: document.getElementById('menu-pizze').value,
            prezzo_primi: parseFloat(document.getElementById('price-primi').value)||5,
            prezzo_secondi: parseFloat(document.getElementById('price-secondi').value)||5,
            prezzo_insalatone: parseFloat(document.getElementById('price-insalatone').value)||6,
            prezzo_pizze: parseFloat(document.getElementById('price-pizze').value)||7,
            prezzo_combo: parseFloat(document.getElementById('price-combo').value)||7,
            pizze_esaurite: document.getElementById('pizze-soldout').checked,
            blocca_ordini: document.getElementById('blocca-ordini').checked
        });
        alert("Menu Aggiornato!");
    }
    function cancellaTutto() { if(confirm("RESET TOTALE GIORNATA?")) { db.ref('ordini').remove(); location.reload(); } }
</script>
</body>
</html>
