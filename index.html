
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordina Pranzo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body style="padding-bottom: 80px;"> <img src="banner.jpg" alt="Mela Stregata" class="hero-image" onerror="this.style.display='none'">

    <div class="container">
        
        <div id="avviso-orari" style="background:#fff3cd; color:#856404; padding:15px; font-size:0.9em; border-radius:5px; margin-bottom:15px; text-align:center; line-height: 1.6;">
            üïí <strong>Ordini:</strong> 09:00 - 12:15 | üçΩÔ∏è <strong>Ritiro:</strong> 12:00 - 14:15<br>
            üìû Info: <a href="tel:+391234567890" style="color:#856404; font-weight:bold;">+39 123 456 7890</a>
            
            <hr style="border-top:1px solid #eecd64; margin:10px 0;">
            
            <div style="font-weight:bold; font-size:1.1em; color:#d35400;">üí∞ LISTINO PREZZI</div>
            <ul style="text-align:left; margin:5px 0 0 20px; padding:0;">
                <li>Solo Primo o Solo Secondo: <strong>‚Ç¨ 5,00</strong></li>
                <li>Solo Contorno: <strong>‚Ç¨ 3,00</strong></li>
                <li>Menu Pizza: <strong>‚Ç¨ 7,00</strong></li>
                <li style="color:#27ae60; background:#e8f5e9; padding:2px 5px; border-radius:4px;">
                    ‚ú® <strong>OFFERTA COMPLETA:</strong> 1 Primo + 1 Secondo + 1 Contorno = <strong>‚Ç¨ 7,00</strong>
                </li>
            </ul>
        </div>
        
        <div id="menu-loading" style="text-align:center; padding:20px; color:#666;">‚è≥ Caricamento menu in corso...</div>

        <div id="menu-completo" class="hidden">
            <div id="sec-primi" class="menu-section">
                <h3>üçù Primi Piatti (‚Ç¨ 5,00)</h3>
                <div class="content"></div>
            </div>
            <div id="sec-secondi" class="menu-section">
                <h3>üçñ Secondi Piatti (‚Ç¨ 5,00)</h3>
                <div class="content"></div>
            </div>
            <div id="sec-contorni" class="menu-section">
                <h3>ü•ó Contorni (‚Ç¨ 3,00)</h3>
                <div class="content"></div>
            </div>
            <div id="sec-pizze" class="menu-section" style="border-left: 5px solid #ffc107;">
                <h3 style="color: #d39e00;">üçï Pizze (‚Ç¨ 7,00)</h3>
                <p><strong>Disponibili oggi:</strong></p>
                <div id="lista-pizze-display" style="margin-bottom:15px; font-style:italic;"></div>
                <p style="font-size:0.9em;">Scrivi la pizza che vuoi:</p>
                <div id="custom-pizza-container">
                    <div class="pizza-input-group">
                        <input type="text" class="pizza-name" placeholder="Es. Margherita...">
                        <input type="number" class="pizza-qty qty-input" value="1" min="1" oninput="calcolaTotale()" onchange="calcolaTotale()">
                    </div>
                </div>
                <button class="add-btn" onclick="aggiungiRigaPizza()">+ Altra Pizza</button>
            </div>
        </div>

        <hr>
        <h3>I tuoi dati</h3>
        
        <input type="text" id="nome" placeholder="Nome e Cognome" required>
        <input type="tel" id="telefono" placeholder="Numero di Telefono (Solo numeri)" 
               pattern="[0-9]*" inputmode="numeric" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
        
        <label>Dove mangi?</label>
        <select id="tipo-ordine" onchange="toggleTavolo()">
            <option value="asporto">Asporto (Porto via)</option>
            <option value="tavolo">Al Tavolo (Mangio qui)</option>
        </select>

        <div id="div-tavolo" class="hidden">
            <input type="text" id="nome-tavolo" placeholder="NOME TAVOLO (es. RUSSO)">
        </div>

        <label>Orario Ritiro/Pranzo</label>
        <select id="orario" required>
            <option value="" disabled selected>-- Scegli Orario --</option>
            <option value="12:00">12:00</option>
            <option value="12:15">12:15</option>
            <option value="12:30">12:30</option>
            <option value="12:45">12:45</option>
            <option value="13:00">13:00</option>
            <option value="13:15">13:15</option>
            <option value="13:30">13:30</option>
            <option value="13:45">13:45</option>
            <option value="14:00">14:00</option>
            <option value="14:15">14:15</option>
        </select>

        <button onclick="inviaOrdine()" style="margin-top:20px; font-size:1.2em;">INVIA ORDINE</button>
    </div>

    <div id="sticky-total" style="position:fixed; bottom:0; left:0; width:100%; background:#2d3436; color:white; padding:15px; text-align:center; font-size:1.3em; font-weight:bold; box-shadow:0 -5px 15px rgba(0,0,0,0.1); z-index:1000;">
        TOTALE: <span id="display-totale" style="color:#00b894;">‚Ç¨ 0,00</span>
    </div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    // ***********************************************************
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { alert("Errore Config: " + e.message); } }
    const db = firebase.database();
    
    // Variabile globale per salvare il totale
    let totaleOrdineCalcolato = 0;

    db.ref('menu').on('value', (snapshot) => {
        document.getElementById('menu-loading').style.display = 'none';
        document.getElementById('menu-completo').classList.remove('hidden');
        const m = snapshot.val();
        if(!m) return;
        renderSection('sec-primi', m.primi, 'primo');
        renderSection('sec-secondi', m.secondi, 'secondo');
        renderSection('sec-contorni', m.contorni, 'contorno');
        const displayPizze = document.getElementById('lista-pizze-display');
        displayPizze.innerHTML = m.pizze ? m.pizze.replace(/\n/g, "<br>") : "Chiedi al personale.";
    }, (error) => {
        document.getElementById('menu-loading').innerHTML = "<strong style='color:red'>Errore caricamento.</strong>";
    });

    // Passiamo il 'tipo' (primo, secondo, contorno) per i calcoli
    function renderSection(sectionId, textData, tipoPiatto) {
        const container = document.querySelector(`#${sectionId} .content`);
        container.innerHTML = "";
        if(!textData) { container.innerHTML = "<em>Niente oggi.</em>"; return; }
        const righe = textData.split('\n');
        righe.forEach(piatto => {
            if(piatto.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'piatto-row';
                div.innerHTML = `<span>${piatto}</span><input type="number" class="qty-piatto" data-nome="${piatto}" data-tipo="${tipoPiatto}" value="0" min="0" oninput="calcolaTotale()" onchange="calcolaTotale()">`;
                container.appendChild(div);
            }
        });
    }

    function aggiungiRigaPizza() {
        const div = document.createElement('div');
        div.className = 'pizza-input-group';
        div.innerHTML = `<input type="text" class="pizza-name" placeholder="Altra pizza..."><input type="number" class="pizza-qty qty-input" value="1" min="1" oninput="calcolaTotale()" onchange="calcolaTotale()">`;
        document.getElementById('custom-pizza-container').appendChild(div);
        calcolaTotale();
    }

    function toggleTavolo() {
        const val = document.getElementById('tipo-ordine').value;
        document.getElementById('div-tavolo').style.display = (val === 'tavolo') ? 'block' : 'none';
    }

    // --- üí∞ IL CERVELLO DEI PREZZI ---
    function calcolaTotale() {
        let nPrimi = 0;
        let nSecondi = 0;
        let nContorni = 0;
        let nPizze = 0;

        // 1. Conta quanti piatti per tipo
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const val = parseInt(input.value) || 0;
            if (val > 0) {
                const tipo = input.dataset.tipo;
                if(tipo === 'primo') nPrimi += val;
                if(tipo === 'secondo') nSecondi += val;
                if(tipo === 'contorno') nContorni += val;
            }
        });

        // 2. Conta pizze
        document.querySelectorAll('.pizza-qty').forEach(input => {
            const val = parseInt(input.value) || 0;
            // Consideriamo pizza solo se c'√® un nome scritto o se √® quella di default attiva
            const group = input.closest('.pizza-input-group');
            const nome = group.querySelector('.pizza-name').value;
            // Contiamo la pizza solo se ha una quantit√† > 0 (il nome √® opzionale per il calcolo prezzo live, ma obbligatorio per invio)
            if(val > 0) nPizze += val;
        });

        // 3. LOGICA OFFERTA (1P + 1S + 1C = 7‚Ç¨)
        // Il numero di menu completi √® il minimo comune tra primi, secondi e contorni
        let nMenuCompleti = Math.min(nPrimi, nSecondi, nContorni);

        // Calcoliamo i piatti "sciolti" rimasti fuori dall'offerta
        let restantiPrimi = nPrimi - nMenuCompleti;
        let restantiSecondi = nSecondi - nMenuCompleti;
        let restantiContorni = nContorni - nMenuCompleti;

        // 4. CALCOLO FINALE
        let costoMenu = nMenuCompleti * 7.00;
        let costoPrimiSecondiSciolti = (restantiPrimi + restantiSecondi) * 5.00;
        let costoContorniSciolti = restantiContorni * 3.00;
        let costoPizze = nPizze * 7.00;

        let totale = costoMenu + costoPrimiSecondiSciolti + costoContorniSciolti + costoPizze;
        
        // Aggiorna variabile globale e display
        totaleOrdineCalcolato = totale;
        document.getElementById('display-totale').innerText = "‚Ç¨ " + totale.toFixed(2).replace('.', ',');
    }

    function inviaOrdine() {
        // --- 1. IL VIGILE DELL'ORARIO ---
        const now = new Date();
        const minutiTotaliAdesso = (now.getHours() * 60) + now.getMinutes();
        const APERTURA = 9 * 60;
        const CHIUSURA = 12 * 60 + 15;

        // SCOMMENTA PER ATTIVARE BLOCCO ORARIO
        /*
        if (minutiTotaliAdesso < APERTURA || minutiTotaliAdesso > CHIUSURA) {
            alert("‚õîÔ∏è ORDINI CHIUSI!\n\nPuoi inviare l'ordine solo tra le 09:00 e le 12:15.");
            return;
        }
        */

        const nome = document.getElementById('nome').value;
        const telefono = document.getElementById('telefono').value;
        const tipo = document.getElementById('tipo-ordine').value;
        const tavolo = document.getElementById('nome-tavolo').value;
        const orarioScelto = document.getElementById('orario').value;

        if(!nome) { alert("Inserisci il tuo nome!"); return; }
        if(!telefono) { alert("Inserisci il numero di telefono!"); return; }
        if(!orarioScelto) { alert("‚ö†Ô∏è Devi scegliere a che ora vuoi mangiare!"); return; }
        if(tipo === 'tavolo' && !tavolo) { alert("Inserisci il nome del tavolo!"); return; }

        let carrello = [];
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const q = parseInt(input.value);
            if(q > 0) carrello.push({ nome: input.dataset.nome, qty: q });
        });
        document.querySelectorAll('.pizza-input-group').forEach(group => {
            const nomePizza = group.querySelector('.pizza-name').value;
            const qPizza = parseInt(group.querySelector('.pizza-qty').value);
            if(nomePizza.trim() !== "" && qPizza > 0) carrello.push({ nome: "PIZZA: " + nomePizza, qty: qPizza });
        });

        if(carrello.length === 0) { alert("Il carrello √® vuoto!"); return; }

        // Ricalcoliamo il totale per sicurezza prima di inviare
        calcolaTotale();

        const ordine = {
            cliente: nome,
            telefono: telefono,
            items: carrello,
            tipo: tipo,
            tavolo: (tipo === 'tavolo') ? tavolo.toUpperCase() : "N/A",
            orario: orarioScelto,
            totale: totaleOrdineCalcolato, // <--- INVIAMO IL TOTALE
            timestamp: Date.now()
        };

        if(confirm(`Il totale √® ‚Ç¨ ${totaleOrdineCalcolato.toFixed(2)}. Confermi l'ordine?`)) {
            db.ref('ordini').push(ordine)
                .then(() => {
                    alert("‚úÖ Ordine Inviato! Totale da pagare: ‚Ç¨ " + totaleOrdineCalcolato.toFixed(2));
                    location.reload();
                })
                .catch(err => alert("Errore invio: " + err.message));
        }
    }
</script>
</body>
</html>









