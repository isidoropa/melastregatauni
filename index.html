
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordina Pranzo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

    <img src="banner.jpg" alt="Mela Stregata" class="hero-image" onerror="this.style.display='none'">

    <div class="container">
        <div id="avviso-orari" style="background:#fff3cd; color:#856404; padding:10px; font-size:0.9em; border-radius:5px; margin-bottom:15px; text-align:center;">
            üïí <strong>Orari di ordinazione:</strong> 09:00 - 12:15<br>
            üçΩÔ∏è <strong>Orari pranzo/ritiro:</strong> 12:00 - 14:15
        </div>
        
        <div id="menu-loading" style="text-align:center; padding:20px; color:#666;">‚è≥ Caricamento menu in corso...</div>

        <div id="menu-completo" class="hidden">
            
            <div id="sec-primi" class="menu-section">
                <h3>üçù Primi Piatti</h3>
                <div class="content"></div>
            </div>

            <div id="sec-secondi" class="menu-section">
                <h3>üçñ Secondi Piatti</h3>
                <div class="content"></div>
            </div>

            <div id="sec-contorni" class="menu-section">
                <h3>ü•ó Contorni</h3>
                <div class="content"></div>
            </div>

            <div id="sec-pizze" class="menu-section" style="border-left: 5px solid #ffc107;">
                <h3 style="color: #d39e00;">üçï Pizze</h3>
                <p><strong>Disponibili oggi:</strong></p>
                <div id="lista-pizze-display" style="margin-bottom:15px; font-style:italic;"></div>
                
                <p style="font-size:0.9em;">Scrivi la pizza che vuoi:</p>
                <div id="custom-pizza-container">
                    <div class="pizza-input-group">
                        <input type="text" class="pizza-name" placeholder="Es. Margherita...">
                        <input type="number" class="pizza-qty qty-input" value="1" min="1">
                    </div>
                </div>
                <button class="add-btn" onclick="aggiungiRigaPizza()">+ Altra Pizza</button>
            </div>

        </div>

        <hr>
        <h3>I tuoi dati</h3>
        
        <input type="text" id="nome" placeholder="Nome e Cognome" required>
        <input type="tel" id="telefono" placeholder="Numero di Telefono" required>
        
        <label>Dove mangi?</label>
        <select id="tipo-ordine" onchange="toggleTavolo()">
            <option value="asporto">Asporto (Porto via)</option>
            <option value="tavolo">Al Tavolo (Mangio qui)</option>
        </select>

        <div id="div-tavolo" class="hidden">
            <input type="text" id="nome-tavolo" placeholder="NOME TAVOLO (es. RUSSO)">
        </div>

        <label>Orario Ritiro/Pranzo</label>
        <select id="orario" required>
            <option value="" disabled selected>-- Scegli Orario --</option>
            <option value="12:00">12:00</option>
            <option value="12:15">12:15</option>
            <option value="12:30">12:30</option>
            <option value="12:45">12:45</option>
            <option value="13:00">13:00</option>
            <option value="13:15">13:15</option>
            <option value="13:30">13:30</option>
            <option value="13:45">13:45</option>
            <option value="14:00">14:00</option>
            <option value="14:15">14:15</option>
        </select>

        <button onclick="inviaOrdine()" style="margin-top:20px; font-size:1.2em;">INVIA ORDINE</button>
    </div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    // ***********************************************************
    // --- CONFIGURAZIONE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    // Inizializza Firebase
    if (!firebase.apps.length) {
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            alert("Errore Config: " + e.message);
        }
    }
    const db = firebase.database();

    // SCARICAMENTO MENU
    db.ref('menu').on('value', (snapshot) => {
        // Nasconde il caricamento e mostra il menu
        document.getElementById('menu-loading').style.display = 'none';
        document.getElementById('menu-completo').classList.remove('hidden');
        
        const m = snapshot.val();
        if(!m) return;
        
        renderSection('sec-primi', m.primi);
        renderSection('sec-secondi', m.secondi);
        renderSection('sec-contorni', m.contorni);
        
        const displayPizze = document.getElementById('lista-pizze-display');
        displayPizze.innerHTML = m.pizze ? m.pizze.replace(/\n/g, "<br>") : "Chiedi al personale.";
    }, (error) => {
        // Se c'√® un errore (es. permessi negati), lo dice
        document.getElementById('menu-loading').innerHTML = 
            "<strong style='color:red'>Errore caricamento: " + error.message + "</strong><br>Controlla le Regole Database.";
    });

    function renderSection(sectionId, textData) {
        const container = document.querySelector(`#${sectionId} .content`);
        container.innerHTML = "";
        if(!textData) { container.innerHTML = "<em>Niente oggi.</em>"; return; }
        const righe = textData.split('\n');
        righe.forEach(piatto => {
            if(piatto.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'piatto-row';
                div.innerHTML = `<span>${piatto}</span><input type="number" class="qty-piatto" data-nome="${piatto}" value="0" min="0">`;
                container.appendChild(div);
            }
        });
    }

    function aggiungiRigaPizza() {
        const div = document.createElement('div');
        div.className = 'pizza-input-group';
        div.innerHTML = `<input type="text" class="pizza-name" placeholder="Altra pizza..."><input type="number" class="pizza-qty qty-input" value="1" min="1">`;
        document.getElementById('custom-pizza-container').appendChild(div);
    }

    function toggleTavolo() {
        const val = document.getElementById('tipo-ordine').value;
        document.getElementById('div-tavolo').style.display = (val === 'tavolo') ? 'block' : 'none';
    }

    function inviaOrdine() {
        // --- ‚õîÔ∏è 1. IL VIGILE DELL'ORARIO (Blocco Severo) ---
        const now = new Date();
        const oraAttuale = now.getHours();
        const minutiAttuali = now.getMinutes();
        
        // Trasformiamo tutto in "minuti totali" per fare un calcolo facile
        // Esempio: le 09:00 sono 540 minuti dall'inizio della giornata
        const minutiTotaliAdesso = (oraAttuale * 60) + minutiAttuali;

        const APERTURA = 9 * 60;        // 09:00 (540 minuti)
        const CHIUSURA = 12 * 60 + 15;  // 12:15 (735 minuti)

        // Se √® troppo presto OPPURE √® troppo tardi...
        if (minutiTotaliAdesso < APERTURA || minutiTotaliAdesso > CHIUSURA) {
            // Formattiamo l'ora per mostrarla nell'avviso (es. 13:07 invece di 13:7)
            const oraBella = oraAttuale + ":" + (minutiAttuali < 10 ? '0' : '') + minutiAttuali;
            
            alert("‚õîÔ∏è ORDINI CHIUSI!\n\nSono le " + oraBella + ".\nPuoi inviare l'ordine solo tra le 09:00 e le 12:15.");
            return; // <--- QUESTO "RETURN" BLOCCA TUTTO, L'ORDINE NON PARTE
        }
        // -----------------------------------------------------------


        // --- 2. RECUPERO DATI ---
        const nome = document.getElementById('nome').value;
        const telefono = document.getElementById('telefono').value;
        const tipo = document.getElementById('tipo-ordine').value;
        const tavolo = document.getElementById('nome-tavolo').value;
        const orarioScelto = document.getElementById('orario').value;

        // --- 3. VALIDAZIONE DATI ---
        if(!nome) { alert("Inserisci il tuo nome!"); return; }
        if(!telefono) { alert("Inserisci il numero di telefono!"); return; }
        
        // Controllo se ha scelto un orario dalla tendina
        if(!orarioScelto) { 
            alert("‚ö†Ô∏è Devi scegliere a che ora vuoi mangiare!"); 
            return; 
        }

        if(tipo === 'tavolo' && !tavolo) { alert("Inserisci il nome del tavolo!"); return; }

        // --- 4. COSTRUZIONE CARRELLO ---
        let carrello = [];
        
        // Piatti normali
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const q = parseInt(input.value);
            if(q > 0) carrello.push({ nome: input.dataset.nome, qty: q });
        });
        
        // Pizze
        document.querySelectorAll('.pizza-input-group').forEach(group => {
            const nomePizza = group.querySelector('.pizza-name').value;
            const qPizza = parseInt(group.querySelector('.pizza-qty').value);
            if(nomePizza.trim() !== "" && qPizza > 0) carrello.push({ nome: "PIZZA: " + nomePizza, qty: qPizza });
        });

        if(carrello.length === 0) { alert("Il carrello √® vuoto! Seleziona almeno un piatto."); return; }

        // --- 5. INVIO A FIREBASE ---
        const ordine = {
            cliente: nome,
            telefono: telefono,
            items: carrello,
            tipo: tipo,
            tavolo: (tipo === 'tavolo') ? tavolo.toUpperCase() : "N/A",
            orario: orarioScelto,
            timestamp: Date.now()
        };

        db.ref('ordini').push(ordine)
            .then(() => {
                alert("‚úÖ Ordine Inviato con successo!\nTi aspettiamo per le " + orarioScelto);
                location.reload(); // Ricarica la pagina per pulire tutto
            })
            .catch(err => alert("Errore invio: " + err.message));
    }
</script>
</body>
</html>








