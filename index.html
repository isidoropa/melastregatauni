<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordina Pranzo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        .pizza-item-confirmed { display: flex; justify-content: space-between; align-items: center; background: #fff3cd; padding: 8px 10px; border-radius: 6px; margin-bottom: 5px; border: 1px solid #ffeeba; }
        .btn-remove-pizza { background: #ff7675; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .btn-confirm-pizza { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: auto; margin-left: 5px; }
        
        /* Stile SOLD OUT */
        .sold-out-row { opacity: 0.6; }
        .sold-out-row span { text-decoration: line-through; color: #d63031; font-weight: bold; }
        .sold-out-row input { background: #eee; border-color: #ddd; cursor: not-allowed; }
        .sold-out-msg { color: #d63031; font-weight: bold; padding: 10px; border: 2px dashed #d63031; border-radius: 8px; text-align: center; background: #fff5f5; }
    </style>
</head>
<body style="padding-bottom: 80px;">

    <img src="banner.jpg" alt="Mela Stregata" class="hero-image" onerror="this.style.display='none'">

    <div class="container">
        <div id="avviso-orari" style="background:#fff3cd; color:#856404; padding:15px; font-size:0.9em; border-radius:5px; margin-bottom:15px; text-align:center; line-height: 1.6;">
            üïí <strong>Ordini:</strong> 09:00 - 12:15 | üçΩÔ∏è <strong>Ritiro:</strong> 12:00 - 14:15<br>
            üìû Info: <a href="tel:+391234567890" style="color:#856404; font-weight:bold;">+39 123 456 7890</a>
            
            <hr style="border-top:1px solid #eecd64; margin:10px 0;">
            
            <div style="font-weight:bold; font-size:1.1em; color:#d35400;">üí∞ LISTINO PREZZI</div>
            <ul style="text-align:left; margin:5px 0 0 20px; padding:0;">
                <li>Solo Primo o Solo Secondo: <strong>‚Ç¨ 5,00</strong></li>
                <li>Insalatona: <strong>‚Ç¨ 6,00</strong></li>
                <li>Solo Contorno: <strong>‚Ç¨ 3,00</strong></li>
                <li>Menu Pizza: <strong>‚Ç¨ 7,00</strong></li>
                <li style="color:#27ae60; background:#e8f5e9; padding:2px 5px; border-radius:4px;">
                    ‚ú® <strong>OFFERTA:</strong> 1 Primo + 1 Secondo + 1 Contorno = <strong>‚Ç¨ 7,00</strong>
                </li>
            </ul>
        </div>
        
        <div id="menu-loading" style="text-align:center; padding:20px; color:#666;">‚è≥ Caricamento menu in corso...</div>

        <div id="menu-completo" class="hidden">
            <div id="sec-primi" class="menu-section">
                <h3>üçù Primi (‚Ç¨ 5,00)</h3> <div class="content"></div>
            </div>
            <div id="sec-secondi" class="menu-section">
                <h3>üçñ Secondi (‚Ç¨ 5,00)</h3> <div class="content"></div>
            </div>
            <div id="sec-contorni" class="menu-section">
                <h3>ü•ó Contorni (‚Ç¨ 3,00)</h3> <div class="content"></div>
            </div>
            <div id="sec-insalatone" class="menu-section" style="border-left: 5px solid #27ae60;">
                <h3 style="color:#27ae60;">ü•¨ Insalatone (‚Ç¨ 6,00)</h3> <div class="content"></div>
            </div>

            <div id="sec-pizze" class="menu-section" style="border-left: 5px solid #ffc107;">
                <h3 style="color: #d39e00;">üçï Pizze (‚Ç¨ 7,00)</h3>
                <div id="lista-pizze-display" style="margin-bottom:15px; font-style:italic;"></div>
                
                <div id="pizza-active-area">
                    <p style="font-size:0.9em; margin-bottom:5px;">Scrivi la pizza e clicca OK per aggiungerla:</p>
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <input type="text" id="temp-pizza-name" placeholder="Es. Margherita" style="margin:0; flex-grow:1;">
                        <input type="number" id="temp-pizza-qty" value="1" min="1" style="margin:0 5px; width:50px; text-align:center;">
                        <button class="btn-confirm-pizza" onclick="confermaPizza()">OK</button>
                    </div>
                </div>

                <div id="pizza-soldout-msg" class="hidden sold-out-msg">
                    üö´ PIZZE ESAURITE PER OGGI
                </div>

                <div id="pizze-aggiunte-list"></div>
            </div>
        </div>

        <hr>
        <h3>I tuoi dati</h3>
        
        <input type="text" id="nome" placeholder="Nome e Cognome" required>
        <input type="tel" id="telefono" placeholder="Telefono (Solo numeri)" 
               pattern="[0-9]*" inputmode="numeric" 
               oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
        
        <label>Dove mangi?</label>
        <select id="tipo-ordine" onchange="toggleTavolo()">
            <option value="asporto">Asporto (Porto via)</option>
            <option value="tavolo">Al Tavolo (Mangio qui)</option>
        </select>

        <div id="div-tavolo" class="hidden" style="background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:15px;">
            <label style="color:#d35400;">Nome del Tavolo:</label>
            <input type="text" id="nome-tavolo" placeholder="ES. RUSSO" style="margin-top:5px;">
            <label style="color:#2980b9;">Quante persone siete?</label>
            <input type="number" id="num-persone" placeholder="Es. 4" min="1" style="margin-top:5px;">
        </div>

        <label>Orario Ritiro/Pranzo</label>
        <select id="orario" required>
            <option value="" disabled selected>-- Scegli Orario --</option>
            <option value="12:00">12:00</option>
            <option value="12:15">12:15</option>
            <option value="12:30">12:30</option>
            <option value="12:45">12:45</option>
            <option value="13:00">13:00</option>
            <option value="13:15">13:15</option>
            <option value="13:30">13:30</option>
            <option value="13:45">13:45</option>
            <option value="14:00">14:00</option>
            <option value="14:15">14:15</option>
        </select>

        <label style="margin-top:20px; display:block;">Note per la cucina (Opzionale)</label>
        <textarea id="note-ordine" rows="3" placeholder="Es. Niente cipolla, allergie, citofonare Rossi..." style="width:100%; border:2px solid #ddd; border-radius:8px; padding:10px;"></textarea>

        <button id="btn-invia" onclick="inviaOrdine()" style="margin-top:20px; font-size:1.2em;">INVIA ORDINE</button>
    </div>

    <div id="sticky-total" style="position:fixed; bottom:0; left:0; width:100%; background:#2d3436; color:white; padding:15px; text-align:center; font-size:1.3em; font-weight:bold; box-shadow:0 -5px 15px rgba(0,0,0,0.1); z-index:1000;">
        TOTALE: <span id="display-totale" style="color:#00b894;">‚Ç¨ 0,00</span>
    </div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    // ***********************************************************
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { alert("Errore Config: " + e.message); } }
    const db = firebase.database();
    
    let totaleOrdineCalcolato = 0;
    let carrelloPizze = [];

    // --- PROTEZIONE USCITA (FEATURE RICHIESTA) ---
    window.onbeforeunload = function() {
        let hasItems = carrelloPizze.length > 0;
        document.querySelectorAll('.qty-piatto').forEach(i => { if(i.value > 0) hasItems = true; });
        
        if (hasItems) {
            return "Hai un ordine in corso. Sei sicuro di voler uscire?";
        }
    };

    window.onload = function() {
        const savedNome = localStorage.getItem('nomeUtente');
        const savedTel = localStorage.getItem('telUtente');
        if(savedNome) document.getElementById('nome').value = savedNome;
        if(savedTel) document.getElementById('telefono').value = savedTel;
    };

    db.ref('menu').on('value', (snapshot) => {
        document.getElementById('menu-loading').style.display = 'none';
        document.getElementById('menu-completo').classList.remove('hidden');
        const m = snapshot.val();
        if(!m) return;
        renderSection('sec-primi', m.primi, 'primo');
        renderSection('sec-secondi', m.secondi, 'secondo');
        renderSection('sec-contorni', m.contorni, 'contorno');
        renderSection('sec-insalatone', m.insalatone, 'insalatona');
        
        document.getElementById('lista-pizze-display').innerHTML = m.pizze ? m.pizze.replace(/\n/g, "<br>") : "Chiedi al personale.";

        const pizzaActive = document.getElementById('pizza-active-area');
        const pizzaMsg = document.getElementById('pizza-soldout-msg');
        
        if (m.pizze_esaurite) {
            pizzaActive.classList.add('hidden');
            pizzaMsg.classList.remove('hidden');
            carrelloPizze = [];
            renderPizzeAggiunte();
            calcolaTotale();
        } else {
            pizzaActive.classList.remove('hidden');
            pizzaMsg.classList.add('hidden');
        }

    }, (error) => {
        document.getElementById('menu-loading').innerHTML = "<strong style='color:red'>Errore caricamento.</strong>";
    });

    function renderSection(sectionId, textData, tipoPiatto) {
        const container = document.querySelector(`#${sectionId} .content`);
        container.innerHTML = "";
        if(!textData) { container.innerHTML = "<em>Niente oggi.</em>"; return; }
        const righe = textData.split('\n');
        
        righe.forEach(piatto => {
            if(piatto.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'piatto-row';
                
                const isSoldOut = piatto.trim().startsWith('[X]');
                let cleanName = piatto;
                let inputHtml = `<input type="number" class="qty-piatto" data-nome="${piatto}" data-tipo="${tipoPiatto}" value="0" min="0" oninput="calcolaTotale()" onchange="calcolaTotale()">`;

                if (isSoldOut) {
                    div.classList.add('sold-out-row');
                    cleanName = piatto.replace('[X]', '').trim() + " (ESAURITO)";
                    inputHtml = `<input type="number" disabled value="0">`;
                }

                div.innerHTML = `<span>${cleanName}</span>${inputHtml}`;
                container.appendChild(div);
            }
        });
    }

    function confermaPizza() {
        const nameInput = document.getElementById('temp-pizza-name');
        const qtyInput = document.getElementById('temp-pizza-qty');
        const nome = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);

        if(nome === "") { alert("Scrivi il nome della pizza!"); return; }
        if(qty < 1) { alert("Quantit√† non valida!"); return; }

        carrelloPizze.push({ nome: "PIZZA: " + nome, qty: qty, tipo: 'pizza' });
        nameInput.value = "";
        qtyInput.value = 1;
        renderPizzeAggiunte();
        calcolaTotale();
    }

    function renderPizzeAggiunte() {
        const container = document.getElementById('pizze-aggiunte-list');
        container.innerHTML = "";
        carrelloPizze.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'pizza-item-confirmed';
            div.innerHTML = `
                <span>üçï <strong>${item.qty}x</strong> ${item.nome.replace("PIZZA: ", "")}</span>
                <button class="btn-remove-pizza" onclick="rimuoviPizza(${index})">X</button>
            `;
            container.appendChild(div);
        });
    }

    function rimuoviPizza(index) {
        carrelloPizze.splice(index, 1);
        renderPizzeAggiunte();
        calcolaTotale();
    }

    function toggleTavolo() {
        const val = document.getElementById('tipo-ordine').value;
        document.getElementById('div-tavolo').style.display = (val === 'tavolo') ? 'block' : 'none';
    }

    function calcolaTotale() {
        let nPrimi = 0, nSecondi = 0, nContorni = 0, nInsalatone = 0, nPizze = 0;
        
        document.querySelectorAll('.qty-piatto').forEach(input => {
            if (!input.disabled) {
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const tipo = input.dataset.tipo;
                    if(tipo === 'primo') nPrimi += val;
                    if(tipo === 'secondo') nSecondi += val;
                    if(tipo === 'contorno') nContorni += val;
                    if(tipo === 'insalatona') nInsalatone += val;
                }
            }
        });

        carrelloPizze.forEach(item => { nPizze += item.qty; });

        let nMenuCompleti = Math.min(nPrimi, nSecondi, nContorni);
        let restoP = nPrimi - nMenuCompleti;
        let restoS = nSecondi - nMenuCompleti;
        let restoC = nContorni - nMenuCompleti;

        let totale = (nMenuCompleti * 7.00) + 
                     ((restoP + restoS) * 5.00) + 
                     (restoC * 3.00) + 
                     (nPizze * 7.00) +
                     (nInsalatone * 6.00);

        totaleOrdineCalcolato = totale;
        document.getElementById('display-totale').innerText = "‚Ç¨ " + totale.toFixed(2).replace('.', ',');
    }

    function inviaOrdine() {
        const nome = document.getElementById('nome').value;
        const telefono = document.getElementById('telefono').value;
        const tipo = document.getElementById('tipo-ordine').value;
        const tavolo = document.getElementById('nome-tavolo').value;
        const numPersone = document.getElementById('num-persone').value;
        const orarioScelto = document.getElementById('orario').value;
        const note = document.getElementById('note-ordine').value;

        if(!nome) { alert("Inserisci il tuo nome!"); return; }
        if(!telefono) { alert("Inserisci il numero di telefono!"); return; }
        if(!orarioScelto) { alert("‚ö†Ô∏è Devi scegliere a che ora vuoi mangiare!"); return; }

        let tavoloFinale = "N/A";
        let coperti = 0;

        if(tipo === 'tavolo') {
            if(!tavolo) { alert("Inserisci il nome del tavolo!"); return; }
            if(!numPersone || numPersone < 1) { alert("Inserisci quante persone siete al tavolo!"); return; }
            tavoloFinale = tavolo.toUpperCase();
            coperti = parseInt(numPersone);
        }

        let carrello = [];
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const q = parseInt(input.value);
            if(q > 0) carrello.push({ nome: input.dataset.nome, qty: q });
        });
        carrelloPizze.forEach(item => { carrello.push(item); });

        if(carrello.length === 0) { alert("Il carrello √® vuoto!"); return; }

        localStorage.setItem('nomeUtente', nome);
        localStorage.setItem('telUtente', telefono);
        calcolaTotale();

        const ordine = {
            cliente: nome,
            telefono: telefono,
            items: carrello,
            tipo: tipo,
            tavolo: tavoloFinale,
            coperti: coperti,
            orario: orarioScelto,
            note: note,
            totale: totaleOrdineCalcolato,
            timestamp: Date.now()
        };

        if(confirm(`Il totale √® ‚Ç¨ ${totaleOrdineCalcolato.toFixed(2)}. Confermi l'ordine?`)) {
            
            // --- ANTI-DOPPIO CLICK (FEATURE RICHIESTA) ---
            const btnInvio = document.getElementById('btn-invia');
            btnInvio.disabled = true;
            btnInvio.innerText = "‚è≥ Invio in corso...";
            btnInvio.style.background = "#ccc";

            // Disattivo protezione uscita perch√© stiamo inviando
            window.onbeforeunload = null;

            db.ref('ordini').push(ordine)
                .then(() => {
                    alert("‚úÖ Ordine Inviato!");
                    location.reload();
                })
                .catch(err => {
                    alert("Errore invio: " + err.message);
                    // Riattivo bottone se fallisce
                    btnInvio.disabled = false;
                    btnInvio.innerText = "INVIA ORDINE";
                    btnInvio.style.background = "";
                });
        }
    }
</script>
</body>
</html>






