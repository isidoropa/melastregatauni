<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ordina Pranzo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --primary: #27ae60;
            --primary-dark: #219150;
            --accent: #e67e22;
            --brand-green: #416058; /* IL TUO VERDE */
            --card-bg: #ffffff;
            --text: #2d3436;
            --text-light: #636e72;
            --radius: 16px;
            --shadow: 0 10px 30px rgba(0,0,0,0.15); /* Ombra un po' pi√π marcata sul verde */
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--brand-green); /* Sfondo verde */
            color: var(--text);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 100px;
        }

        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--brand-green); /* Sfondo contenitore verde */
            min-height: 100vh;
            position: relative;
        }

        .hero-banner {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .content-wrapper { padding: 20px; }

        .info-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: none; /* Tolto bordo grigio, stacca meglio col verde */
        }

        h3 {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .piatto-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed #eee;
        }
        .piatto-row:last-child { border-bottom: none; }
        .piatto-row span { font-size: 0.95em; font-weight: 500; color: #444; flex: 1; padding-right: 10px; }

        input[type="number"] {
            width: 50px;
            padding: 8px;
            border-radius: 10px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 1em;
            font-weight: bold;
            outline: none;
            transition: 0.2s;
        }
        input[type="number"]:focus { border-color: var(--primary); background: #f0fff4; }

        input[type="text"], input[type="tel"], select, textarea {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fff;
            font-family: inherit;
            font-size: 0.95em;
            box-sizing: border-box;
            outline: none;
            transition: 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        }

        label {
            font-size: 0.85em;
            font-weight: 600;
            color: var(--text-light);
            margin-bottom: 5px;
            display: block;
            margin-top: 10px;
        }

        .price-list { list-style: none; padding: 0; margin: 0; }
        .price-list li { display: flex; justify-content: space-between; font-size: 0.9em; padding: 5px 0; color: #555; }
        .offer-box { background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); color: #155724; padding: 10px; border-radius: 10px; margin-top: 10px; font-size: 0.9em; text-align: center; font-weight: 600; }

        button#btn-invia {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; border: none; width: 100%; padding: 16px;
            border-radius: 50px; font-size: 1.1em; font-weight: 700;
            cursor: pointer; box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
            transition: transform 0.2s; margin-top: 10px;
        }
        button#btn-invia:active { transform: scale(0.98); }
        
        .btn-confirm-pizza { background: var(--accent); color: white; border: none; padding: 0 20px; border-radius: 10px; font-weight: bold; cursor: pointer; height: 46px; margin-left: 8px; }

        #sticky-total {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 460px;
            background: #222; /* Sfondo totale pi√π scuro per contrasto col verde */
            color: white;
            padding: 15px 25px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 1.1em; font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        #display-totale { color: #55efc4; font-size: 1.3em; }

        .hidden { display: none !important; }
        .sold-out-row { opacity: 0.5; pointer-events: none; }
        .sold-out-row span { text-decoration: line-through; }
        .pizza-item-confirmed { background: #fff8e1; border: 1px solid #ffe082; padding: 10px; border-radius: 8px; margin-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .btn-remove-pizza { background: #ff7675; color: white; border:none; width:25px; height:25px; border-radius:50%; font-weight:bold; cursor:pointer;}

        #panic-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 99999; text-align: center; padding-top: 30vh; }
        #panic-content { padding: 40px; }
        #panic-content h1 { font-size: 3em; margin: 0; }
    </style>
</head>
<body>

    <div id="panic-banner">
        <div id="panic-content">
            <h1>‚õîÔ∏è</h1>
            <h2 style="color:#d63031;">Cucina Chiusa</h2>
            <p style="font-size:1.1em; color:#555;">Gli ordini sono momentaneamente sospesi.<br>Riprova pi√π tardi.</p>
        </div>
    </div>

    <div class="app-container">
        
        <img src="banner.jpg" alt="Mela Stregata" class="hero-banner" onerror="this.style.display='none'">

        <div class="content-wrapper">
            
            <div class="info-card">
                <div style="text-align:center; margin-bottom:15px;">
                    <h2 style="margin:0; color:var(--primary);">Mela Stregata</h2>
                    <p style="margin:5px 0; font-size:0.9em; color:var(--text-light);">Mensa Universitaria</p>
                    <a href="tel:+391234567890" style="color:var(--accent); font-weight:bold; text-decoration:none;">üìû +39 123 456 7890</a>
                </div>
                <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
                <h4 style="margin:0 0 10px 0; color:var(--text);">üí∞ Listino Oggi</h4>
                <ul class="price-list">
                    <li>Primi/Secondi <strong id="list-primi">...</strong></li>
                    <li>Insalatone <strong id="list-insalatona">...</strong></li>
                    <li>Contorni <strong id="list-contorno">...</strong></li>
                    <li>Pizze <strong id="list-pizza">...</strong></li>
                </ul>
                <div class="offer-box">‚ú® COMBO: 1P + 1S + 1C = <span id="list-combo">...</span></div>
            </div>

            <div id="menu-loading" style="text-align:center; padding:40px; color:white;">
                <div style="font-size:2em;">‚è≥</div><p>Caricamento menu...</p>
            </div>

            <div id="menu-completo" class="hidden">
                <div class="info-card" id="sec-primi"><h3 id="h-primi">üçù Primi</h3> <div class="content"></div></div>
                <div class="info-card" id="sec-secondi"><h3 id="h-secondi">üçñ Secondi</h3> <div class="content"></div></div>
                <div class="info-card" id="sec-contorni"><h3 id="h-contorni">ü•ó Contorni</h3> <div class="content"></div></div>
                <div class="info-card" id="sec-insalatone" style="border-left: 5px solid #27ae60;"><h3 id="h-insalatone">ü•¨ Insalatone</h3> <div class="content"></div></div>

                <div class="info-card" id="sec-pizze" style="border-left: 5px solid var(--accent);">
                    <h3 id="h-pizze" style="color: var(--accent);">üçï Pizze</h3>
                    <p style="font-size:0.9em; color:#666; margin-bottom:10px;" id="lista-pizze-display"></p>
                    <div id="pizza-active-area">
                        <div style="display:flex; align-items:center;">
                            <input type="text" id="temp-pizza-name" placeholder="Es. Margherita" style="margin-bottom:0; border-top-right-radius:0; border-bottom-right-radius:0;">
                            <input type="number" id="temp-pizza-qty" value="1" min="1" style="width:60px; margin-left:-1px; border-radius:0; margin-bottom:0;">
                            <button class="btn-confirm-pizza" onclick="confermaPizza()">OK</button>
                        </div>
                    </div>
                    <div id="pizza-soldout-msg" class="hidden" style="text-align:center; color:#d63031; font-weight:bold; padding:10px; border:2px dashed #d63031; border-radius:10px; margin-top:10px;">üö´ PIZZE ESAURITE</div>
                    <div id="pizze-aggiunte-list" style="margin-top:10px;"></div>
                </div>
            </div>

            <div class="info-card">
                <h3>üë§ I Tuoi Dati</h3>
                <label>Nome e Cognome</label>
                <input type="text" id="nome" placeholder="Mario Rossi">
                <label>Telefono</label>
                <input type="tel" id="telefono" placeholder="333 1234567" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                
                <label>Dove mangi?</label>
                <select id="tipo-ordine" onchange="toggleTavolo()">
                    <option value="asporto">ü•° Asporto (Porto via)</option>
                    <option value="tavolo">üçΩÔ∏è Al Tavolo (Mangio qui)</option>
                </select>

                <div id="div-tavolo" class="hidden" style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:15px;">
                    <label>Nome del Tavolo</label>
                    <input type="text" id="nome-tavolo" placeholder="ES. RUSSO" style="margin-bottom:10px;">
                    <label>Quante persone?</label>
                    <input type="number" id="num-persone" placeholder="Es. 4" min="1" style="width:100%;">
                </div>

                <label>Orario Ritiro</label>
                <select id="orario">
                    <option value="" disabled selected>-- Scegli Orario --</option>
                    <option value="12:00">12:00</option>
                    <option value="12:15">12:15</option>
                    <option value="12:30">12:30</option>
                    <option value="12:45">12:45</option>
                    <option value="13:00">13:00</option>
                    <option value="13:15">13:15</option>
                    <option value="13:30">13:30</option>
                    <option value="13:45">13:45</option>
                    <option value="14:00">14:00</option>
                    <option value="14:15">14:15</option>
                </select>

                <label>Note per la cucina</label>
                <textarea id="note-ordine" rows="2" placeholder="Es. Niente cipolla..."></textarea>

                <button id="btn-invia" onclick="inviaOrdine()">INVIA ORDINE</button>
            </div>
        </div> 
    </div> 

    <div id="sticky-total">
        <span>Totale</span>
        <span id="display-totale">‚Ç¨ 0,00</span>
    </div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    // ***********************************************************
     const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { alert("Errore Config: " + e.message); } }
    const db = firebase.database();
    
    let totaleOrdineCalcolato = 0;
    let carrelloPizze = [];
    let isSystemBlocked = false;
    let P_PRIMI=5, P_SECONDI=5, P_CONTORNI=3, P_INSALATONE=6, P_PIZZE=7, P_COMBO=7;

    window.onbeforeunload = function() {
        let hasItems = carrelloPizze.length > 0;
        document.querySelectorAll('.qty-piatto').forEach(i => { if(i.value > 0) hasItems = true; });
        if (hasItems) return "Hai un ordine in corso. Esci?";
    };

    window.onload = function() {
        const savedNome = localStorage.getItem('nomeUtente');
        const savedTel = localStorage.getItem('telUtente');
        if(savedNome) document.getElementById('nome').value = savedNome;
        if(savedTel) document.getElementById('telefono').value = savedTel;
    };

    db.ref('menu').on('value', (snapshot) => {
        document.getElementById('menu-loading').style.display = 'none';
        document.getElementById('menu-completo').classList.remove('hidden');
        const m = snapshot.val();
        if(!m) return;

        P_PRIMI = m.prezzo_primi || 5; P_SECONDI = m.prezzo_secondi || 5; P_CONTORNI = m.prezzo_contorni || 3;
        P_INSALATONE = m.prezzo_insalatone || 6; P_PIZZE = m.prezzo_pizze || 7; P_COMBO = m.prezzo_combo || 7;

        document.getElementById('list-primi').innerText = "‚Ç¨ " + P_PRIMI.toFixed(2);
        document.getElementById('list-insalatona').innerText = "‚Ç¨ " + P_INSALATONE.toFixed(2);
        document.getElementById('list-contorno').innerText = "‚Ç¨ " + P_CONTORNI.toFixed(2);
        document.getElementById('list-pizza').innerText = "‚Ç¨ " + P_PIZZE.toFixed(2);
        document.getElementById('list-combo').innerText = "‚Ç¨ " + P_COMBO.toFixed(2);

        document.getElementById('h-primi').innerText = `üçù Primi (‚Ç¨ ${P_PRIMI.toFixed(2)})`;
        document.getElementById('h-secondi').innerText = `üçñ Secondi (‚Ç¨ ${P_SECONDI.toFixed(2)})`;
        document.getElementById('h-contorni').innerText = `ü•ó Contorni (‚Ç¨ ${P_CONTORNI.toFixed(2)})`;
        document.getElementById('h-insalatone').innerText = `ü•¨ Insalatone (‚Ç¨ ${P_INSALATONE.toFixed(2)})`;
        document.getElementById('h-pizze').innerText = `üçï Pizze (‚Ç¨ ${P_PIZZE.toFixed(2)})`;

        renderSection('sec-primi', m.primi, 'primo');
        renderSection('sec-secondi', m.secondi, 'secondo');
        renderSection('sec-contorni', m.contorni, 'contorno');
        renderSection('sec-insalatone', m.insalatone, 'insalatona');
        document.getElementById('lista-pizze-display').innerHTML = m.pizze ? m.pizze.replace(/\n/g, "<br>") : "Chiedi al personale.";

        if (m.pizze_esaurite) {
            document.getElementById('pizza-active-area').classList.add('hidden');
            document.getElementById('pizza-soldout-msg').classList.remove('hidden');
            carrelloPizze = []; renderPizzeAggiunte(); 
        } else {
            document.getElementById('pizza-active-area').classList.remove('hidden');
            document.getElementById('pizza-soldout-msg').classList.add('hidden');
        }
        
        calcolaTotale();

        isSystemBlocked = m.blocca_ordini || false;
        const banner = document.getElementById('panic-banner');
        if(isSystemBlocked) { banner.style.display = 'block'; document.body.style.overflow = 'hidden'; } 
        else { banner.style.display = 'none'; document.body.style.overflow = 'auto'; }

    }, (error) => { document.getElementById('menu-loading').innerHTML = "Errore caricamento."; });

    function renderSection(sectionId, textData, tipoPiatto) {
        const container = document.querySelector(`#${sectionId} .content`);
        container.innerHTML = "";
        if(!textData) { container.innerHTML = "<em style='color:#999;'>Nessuna opzione.</em>"; return; }
        const righe = textData.split('\n');
        righe.forEach(piatto => {
            if(piatto.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'piatto-row';
                const isSoldOut = piatto.trim().startsWith('[X]');
                let cleanName = piatto;
                let inputHtml = `<input type="number" class="qty-piatto" data-nome="${piatto}" data-tipo="${tipoPiatto}" value="0" min="0" oninput="calcolaTotale()" onchange="calcolaTotale()">`;
                if (isSoldOut) {
                    div.classList.add('sold-out-row');
                    cleanName = piatto.replace('[X]', '').trim() + " (ESAURITO)";
                    inputHtml = `<input type="number" disabled value="0" style="background:#eee;">`;
                }
                div.innerHTML = `<span>${cleanName}</span>${inputHtml}`;
                container.appendChild(div);
            }
        });
    }

    function confermaPizza() {
        const nameInput = document.getElementById('temp-pizza-name');
        const qtyInput = document.getElementById('temp-pizza-qty');
        const nome = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);
        if(nome === "") { alert("Scrivi il nome della pizza!"); return; }
        if(qty < 1) { alert("Quantit√† non valida!"); return; }
        carrelloPizze.push({ nome: "PIZZA: " + nome, qty: qty, tipo: 'pizza' });
        nameInput.value = ""; qtyInput.value = 1;
        renderPizzeAggiunte(); calcolaTotale();
    }

    function renderPizzeAggiunte() {
        const container = document.getElementById('pizze-aggiunte-list');
        container.innerHTML = "";
        carrelloPizze.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'pizza-item-confirmed';
            div.innerHTML = `<span>üçï <strong>${item.qty}x</strong> ${item.nome.replace("PIZZA: ", "")}</span><button class="btn-remove-pizza" onclick="rimuoviPizza(${index})">‚úï</button>`;
            container.appendChild(div);
        });
    }
    function rimuoviPizza(index) { carrelloPizze.splice(index, 1); renderPizzeAggiunte(); calcolaTotale(); }
    
    function toggleTavolo() {
        const val = document.getElementById('tipo-ordine').value;
        const div = document.getElementById('div-tavolo');
        if (val === 'tavolo') {
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
        }
    }

    function calcolaTotale() {
        let nPrimi = 0, nSecondi = 0, nContorni = 0, nInsalatone = 0, nPizze = 0;
        document.querySelectorAll('.qty-piatto').forEach(input => {
            if (!input.disabled) {
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const tipo = input.dataset.tipo;
                    if(tipo === 'primo') nPrimi += val;
                    if(tipo === 'secondo') nSecondi += val;
                    if(tipo === 'contorno') nContorni += val;
                    if(tipo === 'insalatona') nInsalatone += val;
                }
            }
        });
        carrelloPizze.forEach(item => { nPizze += item.qty; });

        let nMenuCompleti = Math.min(nPrimi, nSecondi, nContorni);
        let restoP = nPrimi - nMenuCompleti;
        let restoS = nSecondi - nMenuCompleti;
        let restoC = nContorni - nMenuCompleti;

        let totale = (nMenuCompleti * P_COMBO) + 
                     (restoP * P_PRIMI) + 
                     (restoS * P_SECONDI) + 
                     (restoC * P_CONTORNI) + 
                     (nPizze * P_PIZZE) + 
                     (nInsalatone * P_INSALATONE);

        totaleOrdineCalcolato = totale;
        document.getElementById('display-totale').innerText = "‚Ç¨ " + totale.toFixed(2).replace('.', ',');
    }

    function inviaOrdine() {
        if (isSystemBlocked) { alert("‚õîÔ∏è SPIACENTI: La cucina ha momentaneamente sospeso gli ordini."); return; }
        const nome = document.getElementById('nome').value;
        const telefono = document.getElementById('telefono').value;
        const tipo = document.getElementById('tipo-ordine').value;
        const tavolo = document.getElementById('nome-tavolo').value;
        const numPersone = document.getElementById('num-persone').value;
        const orarioScelto = document.getElementById('orario').value;
        const note = document.getElementById('note-ordine').value;

        if(!nome) { alert("Inserisci il tuo nome!"); return; }
        if(!telefono) { alert("Inserisci il numero di telefono!"); return; }
        if(!orarioScelto) { alert("‚ö†Ô∏è Devi scegliere a che ora vuoi mangiare!"); return; }

        let tavoloFinale = "N/A";
        let coperti = 0;
        if(tipo === 'tavolo') {
            if(!tavolo) { alert("Inserisci il nome del tavolo!"); return; }
            if(!numPersone || numPersone < 1) { alert("Inserisci quante persone siete al tavolo!"); return; }
            tavoloFinale = tavolo.toUpperCase();
            coperti = parseInt(numPersone);
        }

        let carrello = [];
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const q = parseInt(input.value);
            if(q > 0) carrello.push({ nome: input.dataset.nome, qty: q });
        });
        carrelloPizze.forEach(item => { carrello.push(item); });

        if(carrello.length === 0) { alert("Il carrello √® vuoto!"); return; }
        localStorage.setItem('nomeUtente', nome);
        localStorage.setItem('telUtente', telefono);
        calcolaTotale();

        const ordine = {
            cliente: nome, telefono: telefono, items: carrello, tipo: tipo,
            tavolo: tavoloFinale, coperti: coperti, orario: orarioScelto,
            note: note, totale: totaleOrdineCalcolato, timestamp: Date.now()
        };

        if(confirm(`Il totale √® ‚Ç¨ ${totaleOrdineCalcolato.toFixed(2)}. Confermi l'ordine?`)) {
            const btnInvio = document.getElementById('btn-invia');
            btnInvio.disabled = true; btnInvio.innerText = "‚è≥ Invio in corso..."; btnInvio.style.background = "#bdc3c7";
            window.onbeforeunload = null;
            db.ref('ordini').push(ordine)
                .then(() => { alert("‚úÖ Ordine Inviato!"); location.reload(); })
                .catch(err => { alert("Errore invio: " + err.message); btnInvio.disabled = false; btnInvio.innerText = "INVIA ORDINE"; btnInvio.style.background = ""; });
        }
    }
</script>
</body>
</html>
