<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ordina Pranzo</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        .pizza-item-confirmed { display: flex; justify-content: space-between; align-items: center; background: #fff3cd; padding: 8px 10px; border-radius: 6px; margin-bottom: 5px; border: 1px solid #ffeeba; }
        .btn-remove-pizza { background: #ff7675; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; margin-left: 10px; }
        .btn-confirm-pizza { background: #27ae60; color: white; border: none; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: auto; margin-left: 5px; }
        .sold-out-row { opacity: 0.6; }
        .sold-out-row span { text-decoration: line-through; color: #d63031; font-weight: bold; }
        .sold-out-row input { background: #eee; border-color: #ddd; cursor: not-allowed; }
        .sold-out-msg { color: #d63031; font-weight: bold; padding: 10px; border: 2px dashed #d63031; border-radius: 8px; text-align: center; background: #fff5f5; }
        #panic-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 20000; text-align: center; padding-top: 40vh; }
        #panic-content { background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: 3px solid #d63031; display: inline-block; max-width: 90%; }
    </style>
</head>
<body style="padding-bottom: 80px;">

    <div id="panic-banner">
        <div id="panic-content">
            <h1 style="color:#d63031; margin:0;">‚õîÔ∏è STOP ORDINI</h1>
            <p style="font-size:1.2em; color:#333;">La cucina ha momentaneamente sospeso nuovi ordini.</p>
        </div>
    </div>

    <img src="banner.jpg" alt="Mela Stregata" class="hero-image" onerror="this.style.display='none'">

    <div class="container">
        <div id="avviso-orari" style="background:#fff3cd; color:#856404; padding:15px; font-size:0.9em; border-radius:5px; margin-bottom:15px; text-align:center; line-height: 1.6;">
            üïí <strong>Ordini:</strong> 09:00 - 12:15 | üçΩÔ∏è <strong>Ritiro:</strong> 12:00 - 14:15<br>
            üìû Info: <a href="tel:+391234567890" style="color:#856404; font-weight:bold;">+39 123 456 7890</a>
            <hr style="border-top:1px solid #eecd64; margin:10px 0;">
            <div style="font-weight:bold; font-size:1.1em; color:#d35400;">üí∞ LISTINO PREZZI DI OGGI</div>
            <ul style="text-align:left; margin:5px 0 0 20px; padding:0;">
                <li>Solo Primo/Secondo: <strong id="list-primi">‚Ç¨ ...</strong></li>
                <li>Insalatona: <strong id="list-insalatona">‚Ç¨ ...</strong></li>
                <li>Solo Contorno: <strong id="list-contorno">‚Ç¨ ...</strong></li>
                <li>Menu Pizza: <strong id="list-pizza">‚Ç¨ ...</strong></li>
                <li style="color:#27ae60; background:#e8f5e9; padding:2px 5px; border-radius:4px;">
                    ‚ú® <strong>OFFERTA:</strong> 1P + 1S + 1C = <strong id="list-combo">‚Ç¨ ...</strong>
                </li>
            </ul>
        </div>
        
        <div id="menu-loading" style="text-align:center; padding:20px; color:#666;">‚è≥ Caricamento menu e prezzi...</div>

        <div id="menu-completo" class="hidden">
            <div id="sec-primi" class="menu-section">
                <h3 id="h-primi">üçù Primi</h3> <div class="content"></div>
            </div>
            <div id="sec-secondi" class="menu-section">
                <h3 id="h-secondi">üçñ Secondi</h3> <div class="content"></div>
            </div>
            <div id="sec-contorni" class="menu-section">
                <h3 id="h-contorni">ü•ó Contorni</h3> <div class="content"></div>
            </div>
            <div id="sec-insalatone" class="menu-section" style="border-left: 5px solid #27ae60;">
                <h3 id="h-insalatone" style="color:#27ae60;">ü•¨ Insalatone</h3> <div class="content"></div>
            </div>

            <div id="sec-pizze" class="menu-section" style="border-left: 5px solid #ffc107;">
                <h3 id="h-pizze" style="color: #d39e00;">üçï Pizze</h3>
                <div id="lista-pizze-display" style="margin-bottom:15px; font-style:italic;"></div>
                
                <div id="pizza-active-area">
                    <p style="font-size:0.9em; margin-bottom:5px;">Scrivi la pizza e clicca OK:</p>
                    <div style="display:flex; align-items:center; margin-bottom:10px;">
                        <input type="text" id="temp-pizza-name" placeholder="Es. Margherita" style="margin:0; flex-grow:1;">
                        <input type="number" id="temp-pizza-qty" value="1" min="1" style="margin:0 5px; width:50px; text-align:center;">
                        <button class="btn-confirm-pizza" onclick="confermaPizza()">OK</button>
                    </div>
                </div>
                <div id="pizza-soldout-msg" class="hidden sold-out-msg">üö´ PIZZE ESAURITE PER OGGI</div>
                <div id="pizze-aggiunte-list"></div>
            </div>
        </div>

        <hr>
        <h3>I tuoi dati</h3>
        <input type="text" id="nome" placeholder="Nome e Cognome" required>
        <input type="tel" id="telefono" placeholder="Telefono (Solo numeri)" pattern="[0-9]*" inputmode="numeric" oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
        <label>Dove mangi?</label>
        <select id="tipo-ordine" onchange="toggleTavolo()">
            <option value="asporto">Asporto (Porto via)</option>
            <option value="tavolo">Al Tavolo (Mangio qui)</option>
        </select>
        <div id="div-tavolo" class="hidden" style="background:#f9f9f9; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:15px;">
            <label style="color:#d35400;">Nome del Tavolo:</label>
            <input type="text" id="nome-tavolo" placeholder="ES. RUSSO" style="margin-top:5px;">
            <label style="color:#2980b9;">Quante persone siete?</label>
            <input type="number" id="num-persone" placeholder="Es. 4" min="1" style="margin-top:5px;">
        </div>
        <label>Orario Ritiro/Pranzo</label>
        <select id="orario" required>
            <option value="" disabled selected>-- Scegli Orario --</option>
            <option value="12:00">12:00</option>
            <option value="12:15">12:15</option>
            <option value="12:30">12:30</option>
            <option value="12:45">12:45</option>
            <option value="13:00">13:00</option>
            <option value="13:15">13:15</option>
            <option value="13:30">13:30</option>
            <option value="13:45">13:45</option>
            <option value="14:00">14:00</option>
            <option value="14:15">14:15</option>
        </select>
        <label style="margin-top:20px; display:block;">Note (Opzionale)</label>
        <textarea id="note-ordine" rows="3" placeholder="Es. Allergie, Niente cipolla..." style="width:100%; border:2px solid #ddd; border-radius:8px; padding:10px;"></textarea>

        <button id="btn-invia" onclick="inviaOrdine()" style="margin-top:20px; font-size:1.2em;">INVIA ORDINE</button>
    </div>

    <div id="sticky-total" style="position:fixed; bottom:0; left:0; width:100%; background:#2d3436; color:white; padding:15px; text-align:center; font-size:1.3em; font-weight:bold; box-shadow:0 -5px 15px rgba(0,0,0,0.1); z-index:1000;">
        TOTALE: <span id="display-totale" style="color:#00b894;">‚Ç¨ 0,00</span>
    </div>

<script>
    // ***********************************************************
    // üëá INCOLLA LE TUE CHIAVI FIREBASE QUI SOTTO üëá
    // ***********************************************************
   const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    // ***********************************************************

    if (!firebase.apps.length) { try { firebase.initializeApp(firebaseConfig); } catch(e) { alert("Errore Config: " + e.message); } }
    const db = firebase.database();
    
    let totaleOrdineCalcolato = 0;
    let carrelloPizze = [];
    let isSystemBlocked = false;
    
    // VARIABILI PREZZI GLOBALI (Default)
    let P_PRIMI = 5;
    let P_SECONDI = 5;
    let P_CONTORNI = 3;
    let P_INSALATONE = 6;
    let P_PIZZE = 7;
    let P_COMBO = 7;

    window.onbeforeunload = function() {
        let hasItems = carrelloPizze.length > 0;
        document.querySelectorAll('.qty-piatto').forEach(i => { if(i.value > 0) hasItems = true; });
        if (hasItems) return "Hai un ordine in corso. Esci?";
    };

    window.onload = function() {
        const savedNome = localStorage.getItem('nomeUtente');
        const savedTel = localStorage.getItem('telUtente');
        if(savedNome) document.getElementById('nome').value = savedNome;
        if(savedTel) document.getElementById('telefono').value = savedTel;
    };

    db.ref('menu').on('value', (snapshot) => {
        document.getElementById('menu-loading').style.display = 'none';
        document.getElementById('menu-completo').classList.remove('hidden');
        const m = snapshot.val();
        if(!m) return;

        // --- 1. AGGIORNA PREZZI DAL DB ---
        P_PRIMI = m.prezzo_primi || 5;
        P_SECONDI = m.prezzo_secondi || 5;
        P_CONTORNI = m.prezzo_contorni || 3;
        P_INSALATONE = m.prezzo_insalatone || 6;
        P_PIZZE = m.prezzo_pizze || 7;
        P_COMBO = m.prezzo_combo || 7;

        // --- 2. AGGIORNA GRAFICA LISTINO ---
        document.getElementById('list-primi').innerText = "‚Ç¨ " + P_PRIMI.toFixed(2);
        document.getElementById('list-insalatona').innerText = "‚Ç¨ " + P_INSALATONE.toFixed(2);
        document.getElementById('list-contorno').innerText = "‚Ç¨ " + P_CONTORNI.toFixed(2);
        document.getElementById('list-pizza').innerText = "‚Ç¨ " + P_PIZZE.toFixed(2);
        document.getElementById('list-combo').innerText = "‚Ç¨ " + P_COMBO.toFixed(2);

        // --- 3. AGGIORNA TITOLI SEZIONI ---
        document.getElementById('h-primi').innerText = `üçù Primi (‚Ç¨ ${P_PRIMI.toFixed(2)})`;
        document.getElementById('h-secondi').innerText = `üçñ Secondi (‚Ç¨ ${P_SECONDI.toFixed(2)})`;
        document.getElementById('h-contorni').innerText = `ü•ó Contorni (‚Ç¨ ${P_CONTORNI.toFixed(2)})`;
        document.getElementById('h-insalatone').innerText = `ü•¨ Insalatone (‚Ç¨ ${P_INSALATONE.toFixed(2)})`;
        document.getElementById('h-pizze').innerText = `üçï Pizze (‚Ç¨ ${P_PIZZE.toFixed(2)})`;

        // --- 4. RENDER MENU ---
        renderSection('sec-primi', m.primi, 'primo');
        renderSection('sec-secondi', m.secondi, 'secondo');
        renderSection('sec-contorni', m.contorni, 'contorno');
        renderSection('sec-insalatone', m.insalatone, 'insalatona');
        document.getElementById('lista-pizze-display').innerHTML = m.pizze ? m.pizze.replace(/\n/g, "<br>") : "Chiedi al personale.";

        if (m.pizze_esaurite) {
            document.getElementById('pizza-active-area').classList.add('hidden');
            document.getElementById('pizza-soldout-msg').classList.remove('hidden');
            carrelloPizze = []; renderPizzeAggiunte(); 
        } else {
            document.getElementById('pizza-active-area').classList.remove('hidden');
            document.getElementById('pizza-soldout-msg').classList.add('hidden');
        }
        
        // Ricalcola il totale con i nuovi prezzi
        calcolaTotale();

        isSystemBlocked = m.blocca_ordini || false;
        const banner = document.getElementById('panic-banner');
        if(isSystemBlocked) { banner.style.display = 'block'; document.body.style.overflow = 'hidden'; } 
        else { banner.style.display = 'none'; document.body.style.overflow = 'auto'; }

    }, (error) => {
        document.getElementById('menu-loading').innerHTML = "<strong style='color:red'>Errore caricamento.</strong>";
    });

    function renderSection(sectionId, textData, tipoPiatto) {
        const container = document.querySelector(`#${sectionId} .content`);
        container.innerHTML = "";
        if(!textData) { container.innerHTML = "<em>Niente oggi.</em>"; return; }
        const righe = textData.split('\n');
        righe.forEach(piatto => {
            if(piatto.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'piatto-row';
                const isSoldOut = piatto.trim().startsWith('[X]');
                let cleanName = piatto;
                let inputHtml = `<input type="number" class="qty-piatto" data-nome="${piatto}" data-tipo="${tipoPiatto}" value="0" min="0" oninput="calcolaTotale()" onchange="calcolaTotale()">`;
                if (isSoldOut) {
                    div.classList.add('sold-out-row');
                    cleanName = piatto.replace('[X]', '').trim() + " (ESAURITO)";
                    inputHtml = `<input type="number" disabled value="0">`;
                }
                div.innerHTML = `<span>${cleanName}</span>${inputHtml}`;
                container.appendChild(div);
            }
        });
    }

    function confermaPizza() {
        const nameInput = document.getElementById('temp-pizza-name');
        const qtyInput = document.getElementById('temp-pizza-qty');
        const nome = nameInput.value.trim();
        const qty = parseInt(qtyInput.value);
        if(nome === "") { alert("Scrivi il nome della pizza!"); return; }
        if(qty < 1) { alert("Quantit√† non valida!"); return; }
        carrelloPizze.push({ nome: "PIZZA: " + nome, qty: qty, tipo: 'pizza' });
        nameInput.value = ""; qtyInput.value = 1;
        renderPizzeAggiunte(); calcolaTotale();
    }

    function renderPizzeAggiunte() {
        const container = document.getElementById('pizze-aggiunte-list');
        container.innerHTML = "";
        carrelloPizze.forEach((item, index) => {
            const div = document.createElement('div');
            div.className = 'pizza-item-confirmed';
            div.innerHTML = `<span>üçï <strong>${item.qty}x</strong> ${item.nome.replace("PIZZA: ", "")}</span><button class="btn-remove-pizza" onclick="rimuoviPizza(${index})">X</button>`;
            container.appendChild(div);
        });
    }
    function rimuoviPizza(index) { carrelloPizze.splice(index, 1); renderPizzeAggiunte(); calcolaTotale(); }
    function toggleTavolo() { document.getElementById('div-tavolo').style.display = (document.getElementById('tipo-ordine').value === 'tavolo') ? 'block' : 'none'; }

    // --- CALCOLO TOTALE DINAMICO ---
    function calcolaTotale() {
        let nPrimi = 0, nSecondi = 0, nContorni = 0, nInsalatone = 0, nPizze = 0;
        document.querySelectorAll('.qty-piatto').forEach(input => {
            if (!input.disabled) {
                const val = parseInt(input.value) || 0;
                if (val > 0) {
                    const tipo = input.dataset.tipo;
                    if(tipo === 'primo') nPrimi += val;
                    if(tipo === 'secondo') nSecondi += val;
                    if(tipo === 'contorno') nContorni += val;
                    if(tipo === 'insalatona') nInsalatone += val;
                }
            }
        });
        carrelloPizze.forEach(item => { nPizze += item.qty; });

        let nMenuCompleti = Math.min(nPrimi, nSecondi, nContorni);
        let restoP = nPrimi - nMenuCompleti;
        let restoS = nSecondi - nMenuCompleti;
        let restoC = nContorni - nMenuCompleti;

        // CALCOLO CON PREZZI DINAMICI
        let totale = (nMenuCompleti * P_COMBO) + 
                     ((restoP + restoS) * P_SECONDI) + // Assumiamo Primi e Secondi stesso prezzo base se sciolti, o si pu√≤ usare P_PRIMI
                     (restoC * P_CONTORNI) + 
                     (nPizze * P_PIZZE) + 
                     (nInsalatone * P_INSALATONE);
                     
        // Nota: Se Primi e Secondi hanno prezzi diversi sciolti, la logica "restoP + restoS" va raffinata,
        // ma in genere nelle mense P e S costano uguale. Qui uso P_SECONDI come base.
        // Se vuoi essere preciso: (restoP * P_PRIMI) + (restoS * P_SECONDI).
        
        totale = (nMenuCompleti * P_COMBO) + 
                 (restoP * P_PRIMI) + 
                 (restoS * P_SECONDI) + 
                 (restoC * P_CONTORNI) + 
                 (nPizze * P_PIZZE) + 
                 (nInsalatone * P_INSALATONE);

        totaleOrdineCalcolato = totale;
        document.getElementById('display-totale').innerText = "‚Ç¨ " + totale.toFixed(2).replace('.', ',');
    }

    function inviaOrdine() {
        if (isSystemBlocked) { alert("‚õîÔ∏è SPIACENTI: La cucina ha momentaneamente sospeso gli ordini."); return; }
        const nome = document.getElementById('nome').value;
        const telefono = document.getElementById('telefono').value;
        const tipo = document.getElementById('tipo-ordine').value;
        const tavolo = document.getElementById('nome-tavolo').value;
        const numPersone = document.getElementById('num-persone').value;
        const orarioScelto = document.getElementById('orario').value;
        const note = document.getElementById('note-ordine').value;

        if(!nome) { alert("Inserisci il tuo nome!"); return; }
        if(!telefono) { alert("Inserisci il numero di telefono!"); return; }
        if(!orarioScelto) { alert("‚ö†Ô∏è Devi scegliere a che ora vuoi mangiare!"); return; }

        let tavoloFinale = "N/A";
        let coperti = 0;
        if(tipo === 'tavolo') {
            if(!tavolo) { alert("Inserisci il nome del tavolo!"); return; }
            if(!numPersone || numPersone < 1) { alert("Inserisci quante persone siete al tavolo!"); return; }
            tavoloFinale = tavolo.toUpperCase();
            coperti = parseInt(numPersone);
        }

        let carrello = [];
        document.querySelectorAll('.qty-piatto').forEach(input => {
            const q = parseInt(input.value);
            if(q > 0) carrello.push({ nome: input.dataset.nome, qty: q });
        });
        carrelloPizze.forEach(item => { carrello.push(item); });

        if(carrello.length === 0) { alert("Il carrello √® vuoto!"); return; }
        localStorage.setItem('nomeUtente', nome);
        localStorage.setItem('telUtente', telefono);
        calcolaTotale();

        const ordine = {
            cliente: nome, telefono: telefono, items: carrello, tipo: tipo,
            tavolo: tavoloFinale, coperti: coperti, orario: orarioScelto,
            note: note, totale: totaleOrdineCalcolato, timestamp: Date.now()
        };

        if(confirm(`Il totale √® ‚Ç¨ ${totaleOrdineCalcolato.toFixed(2)}. Confermi l'ordine?`)) {
            const btnInvio = document.getElementById('btn-invia');
            btnInvio.disabled = true; btnInvio.innerText = "‚è≥ Invio in corso..."; btnInvio.style.background = "#ccc";
            window.onbeforeunload = null;
            db.ref('ordini').push(ordine)
                .then(() => { alert("‚úÖ Ordine Inviato!"); location.reload(); })
                .catch(err => { alert("Errore invio: " + err.message); btnInvio.disabled = false; btnInvio.innerText = "INVIA ORDINE"; btnInvio.style.background = ""; });
        }
    }
</script>
</body>
</html>

