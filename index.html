<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mela Stregata</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root {
            --brand-green: #416058;
            --accent: #e67e22;
            --text-dark: #2d3436;
            --bg-card: #ffffff;
            --gray-light: #f4f6f8;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { font-family: 'Poppins', sans-serif; background-color: var(--brand-green); margin: 0; padding: 0; color: var(--text-dark); padding-bottom: 120px; }

        .hero-header { position: relative; height: 180px; overflow: hidden; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .hero-img { width: 100%; height: 100%; object-fit: cover; }
        
        .container { max-width: 600px; margin: 0 auto; padding: 20px; position: relative; top: -40px; }

        .card { background: var(--bg-card); border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 20px; }

        h2 { margin: 0 0 5px 0; color: var(--brand-green); font-size: 1.6em; }
        h3 { font-size: 1.2em; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; color: var(--text-dark); }
        
        .price-row { display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 6px; color: #555; }
        .promo-badge { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 8px; border-radius: 10px; text-align: center; font-weight: 600; font-size: 0.9em; margin-top: 10px; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }

        .piatto-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .piatto-row:last-child { border-bottom: none; }
        .piatto-nome { flex: 1; font-weight: 500; font-size: 0.95em; line-height: 1.3; padding-right: 10px; }
        
        .stepper { display: flex; align-items: center; background: var(--gray-light); border-radius: 12px; padding: 2px; }
        .stepper-btn { width: 36px; height: 36px; border: none; background: white; border-radius: 10px; font-weight: bold; font-size: 1.2em; color: var(--brand-green); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }
        .stepper-btn:active { transform: scale(0.9); background: #eee; }
        .stepper-val { width: 30px; text-align: center; font-weight: 600; font-size: 1em; background: transparent; border: none; padding: 0; }

        label { font-size: 0.85em; font-weight: 600; color: #888; margin-top: 15px; display: block; margin-bottom: 5px; }
        input[type="text"], input[type="tel"], select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; background: #f9f9f9; outline: none; transition: 0.3s; font-family: inherit; font-weight: 500; }
        input:focus, select:focus, textarea:focus { border-color: var(--brand-green); background: #fff; }

        .bottom-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; max-width: 560px; margin: 0 auto; background: rgba(45, 52, 54, 0.95); backdrop-filter: blur(10px); padding: 10px 10px 10px 20px; border-radius: 50px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 100; color: white; }
        .total-price { font-size: 1.2em; font-weight: 700; color: #55efc4; }
        .total-label { font-size: 0.8em; opacity: 0.7; display: block; line-height: 1; }
        
        #btn-invia { background: white; color: var(--text-dark); border: none; padding: 12px 25px; border-radius: 30px; font-weight: 700; font-size: 1em; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        #btn-invia:disabled { opacity: 0.7; background: #ccc; }

        .pizza-input-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-add-pizza { background: var(--accent); color: white; border: none; border-radius: 12px; width: 50px; font-weight: bold; font-size: 1.2em; }
        .pizza-list-item { background: #fff8e1; padding: 10px; border-radius: 10px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; font-weight: 500; }
        .btn-del-pizza { background: #ff7675; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; font-weight: bold; }

        .hidden { display: none !important; }
        .sold-out { opacity: 0.5; pointer-events: none; text-decoration: line-through; }
        
        #panic-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 30px; display: none; }
    </style>
</head>
<body>

    <div id="panic-screen">
        <div style="font-size: 4em;">‚õîÔ∏è</div>
        <h2 style="color:#d63031; margin-top:10px;">Cucina Chiusa</h2>
        <p style="color:#666; font-size:1.1em;">Al momento non accettiamo nuovi ordini.<br>Riprova pi√π tardi.</p>
    </div>

    <div class="hero-header">
        <img src="banner.jpg" alt="Mensa" class="hero-img" onerror="this.src='https://via.placeholder.com/800x400/416058/ffffff?text=Mela+Stregata'">
    </div>

    <div class="container">
        
        <div class="card">
            <div style="text-align:center;">
                <h2>Mela Stregata</h2>
                <p style="color:#888; margin:5px 0;">Mensa Universitaria</p>
                <a href="tel:123456789" style="color:var(--accent); text-decoration:none; font-weight:600;">üìû Chiama Info</a>
            </div>
            
            <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">
            
            <div class="price-row"><span>üçù Primi / üçñ Secondi</span><strong id="p-primi">‚Ç¨ 5,00</strong></div>
            <div class="price-row"><span>ü•ó Contorni</span><strong id="p-contorni">‚Ç¨ 3,00</strong></div>
            <div class="price-row"><span>ü•¨ Insalatone</span><strong id="p-insalatone">‚Ç¨ 6,00</strong></div>
            <div class="price-row"><span>üçï Menu Pizza</span><strong id="p-pizza">‚Ç¨ 7,00</strong></div>
            
            <div class="promo-badge">
                üî• COMBO: 1P + 1S + 1C = <span id="p-combo">‚Ç¨ 7,00</span>
            </div>
        </div>

        <div id="loading" style="text-align:center; color:white; padding:20px;">Caricamento menu...</div>

        <div id="menu-content" class="hidden">
            
            <div class="card">
                <h3 id="t-primi">üçù Primi</h3>
                <div id="list-primi"></div>
            </div>

            <div class="card">
                <h3 id="t-secondi">üçñ Secondi</h3>
                <div id="list-secondi"></div>
            </div>

            <div class="card">
                <h3 id="t-contorni">ü•ó Contorni</h3>
                <div id="list-contorni"></div>
            </div>

            <div class="card" style="border-left: 5px solid #27ae60;">
                <h3 id="t-insalatone" style="color:#27ae60;">ü•¨ Insalatone</h3>
                <div id="list-insalatone"></div>
            </div>

            <div class="card" style="border-left: 5px solid var(--accent);">
                <h3 id="t-pizze" style="color:var(--accent);">üçï Pizze</h3>
                <p id="desc-pizze" style="font-size:0.85em; color:#777; margin-bottom:15px;"></p>
                
                <div id="pizza-area">
                    <label style="margin-top:0;">Aggiungi Pizza:</label>
                    <div class="pizza-input-group">
                        <input type="text" id="pizza-name" placeholder="Es. Margherita">
                        <button class="btn-add-pizza" onclick="addPizza()">+</button>
                    </div>
                </div>
                <div id="pizza-closed" class="hidden" style="color:#d63031; font-weight:bold; text-align:center; padding:10px;">üö´ Pizze Esaurite</div>
                
                <div id="pizza-cart"></div>
            </div>

            <div class="card">
                <h3>üë§ I Tuoi Dati</h3>
                <label>Nome e Cognome</label>
                <input type="text" id="nome" placeholder="Mario Rossi" autocomplete="name">
                
                <label>Telefono</label>
                <input type="tel" id="telefono" placeholder="333 1234567" pattern="[0-9]*" inputmode="numeric" autocomplete="tel">
                
                <label>Dove mangi?</label>
                <select id="tipo" onchange="checkTavolo()">
                    <option value="asporto">ü•° Asporto (Porto via)</option>
                    <option value="tavolo">üçΩÔ∏è Al Tavolo (Mangio qui)</option>
                </select>

                <div id="box-tavolo" class="hidden" style="background:#f0f8ff; padding:15px; border-radius:12px; margin-top:10px;">
                    <label style="color:#2980b9; margin-top:0;">Nome del Tavolo</label>
                    <input type="text" id="tavolo-nome" placeholder="ES. RUSSO">
                    <label style="color:#2980b9;">Numero Persone</label>
                    <input type="tel" id="tavolo-persone" placeholder="4" inputmode="numeric" style="width:100px;">
                </div>

                <label>Orario Ritiro/Pranzo</label>
                <select id="orario">
                    <option value="" disabled selected>-- Seleziona --</option>
                    <option value="12:00">12:00</option>
                    <option value="12:15">12:15</option>
                    <option value="12:30">12:30</option>
                    <option value="12:45">12:45</option>
                    <option value="13:00">13:00</option>
                    <option value="13:15">13:15</option>
                    <option value="13:30">13:30</option>
                    <option value="13:45">13:45</option>
                    <option value="14:00">14:00</option>
                    <option value="14:15">14:15</option>
                </select>

                <label>Note (Allergie, extra...)</label>
                <textarea id="note" rows="2" placeholder="Scrivi qui..."></textarea>
            </div>
        </div>
    </div>

    <div class="bottom-bar">
        <div>
            <span class="total-label">TOTALE</span>
            <span class="total-price" id="view-total">‚Ç¨ 0,00</span>
        </div>
        <button id="btn-invia" onclick="sendOrder()">INVIA ORDINE üöÄ</button>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCJW_sE3dDakc85xCvj73P8DOYdXxD5JDU",
        authDomain: "melastregatauni.firebaseapp.com",
        // Nota: questo URL √® importante perch√© il tuo database √® in Europa
        databaseURL: "https://melastregatauni-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "melastregatauni",
        storageBucket: "melastregatauni.firebasestorage.app",
        messagingSenderId: "438544443213",
        appId: "1:438544443213:web:f30f121f0642b8e8a9b904"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let P = { primi:5, secondi:5, contorni:3, insalatone:6, pizze:7, combo:7 };
    let cartPizze = [];
    let isPanic = false;

    window.onbeforeunload = () => {
        let hasFood = cartPizze.length > 0;
        document.querySelectorAll('.stepper-val').forEach(i => { if(parseInt(i.value)>0) hasFood=true; });
        if(hasFood) return "Ordine in corso. Uscire?";
    };

    window.onload = () => {
        if(localStorage.getItem('user')) document.getElementById('nome').value = localStorage.getItem('user');
        if(localStorage.getItem('phone')) document.getElementById('telefono').value = localStorage.getItem('phone');
    };

    db.ref('menu').on('value', snap => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('menu-content').classList.remove('hidden');
        const m = snap.val();
        if(!m) return;

        P.primi = m.prezzo_primi || 5; 
        P.secondi = m.prezzo_secondi || 5;
        P.contorni = m.prezzo_contorni || 3;
        P.insalatone = m.prezzo_insalatone || 6;
        P.pizze = m.prezzo_pizze || 7;
        P.combo = m.prezzo_combo || 7;

        updatePricesUI();
        renderList('list-primi', m.primi, 'primo');
        renderList('list-secondi', m.secondi, 'secondo');
        renderList('list-contorni', m.contorni, 'contorno');
        renderList('list-insalatone', m.insalatone, 'insalatona');
        
        document.getElementById('desc-pizze').innerText = m.pizze || "Chiedi disponibilit√†";
        
        if(m.pizze_esaurite) {
            document.getElementById('pizza-area').classList.add('hidden');
            document.getElementById('pizza-closed').classList.remove('hidden');
            cartPizze = []; renderPizze(); calc();
        } else {
            document.getElementById('pizza-area').classList.remove('hidden');
            document.getElementById('pizza-closed').classList.add('hidden');
        }

        isPanic = m.blocca_ordini || false;
        document.getElementById('panic-screen').style.display = isPanic ? 'flex' : 'none';
        document.body.style.overflow = isPanic ? 'hidden' : 'auto';

        calc();
    });

    function updatePricesUI() {
        document.getElementById('p-primi').innerText = "‚Ç¨ "+P.primi.toFixed(2);
        document.getElementById('p-contorni').innerText = "‚Ç¨ "+P.contorni.toFixed(2);
        document.getElementById('p-insalatone').innerText = "‚Ç¨ "+P.insalatone.toFixed(2);
        document.getElementById('p-pizza').innerText = "‚Ç¨ "+P.pizze.toFixed(2);
        document.getElementById('p-combo').innerText = "‚Ç¨ "+P.combo.toFixed(2);
        
        document.getElementById('t-primi').innerText = `üçù Primi (‚Ç¨ ${P.primi})`;
        document.getElementById('t-secondi').innerText = `üçñ Secondi (‚Ç¨ ${P.secondi})`;
        document.getElementById('t-contorni').innerText = `ü•ó Contorni (‚Ç¨ ${P.contorni})`;
        document.getElementById('t-insalatone').innerText = `ü•¨ Insalatone (‚Ç¨ ${P.insalatone})`;
        document.getElementById('t-pizze').innerText = `üçï Pizze (‚Ç¨ ${P.pizze})`;
    }

    function renderList(id, text, type) {
        const el = document.getElementById(id);
        el.innerHTML = "";
        if(!text) { el.innerHTML = "<small style='color:#999'>Niente oggi.</small>"; return; }
        
        text.split('\n').forEach(line => {
            if(!line.trim()) return;
            const isSold = line.trim().startsWith('[X]');
            const name = isSold ? line.replace('[X]','').trim() + " (FINITO)" : line.trim();
            const rowClass = isSold ? "piatto-row sold-out" : "piatto-row";
            const disable = isSold ? "disabled" : "";

            const html = `
            <div class="${rowClass}">
                <div class="piatto-nome">${name}</div>
                <div class="stepper">
                    <button class="stepper-btn" onclick="step(this, -1)" ${disable}>-</button>
                    <input type="text" class="stepper-val" value="0" readonly data-type="${type}" data-name="${name}">
                    <button class="stepper-btn" onclick="step(this, 1)" ${disable}>+</button>
                </div>
            </div>`;
            el.insertAdjacentHTML('beforeend', html);
        });
    }

    window.step = function(btn, delta) {
        const input = btn.parentElement.querySelector('input');
        let val = parseInt(input.value) || 0;
        val += delta;
        if(val < 0) val = 0;
        input.value = val;
        calc();
    }

    window.addPizza = function() {
        const inp = document.getElementById('pizza-name');
        const name = inp.value.trim();
        if(!name) return alert("Scrivi il nome della pizza");
        cartPizze.push({ name: "PIZZA: "+name, qty: 1 });
        inp.value = "";
        renderPizze(); calc();
    }
    
    function renderPizze() {
        const c = document.getElementById('pizza-cart');
        c.innerHTML = "";
        cartPizze.forEach((p, i) => {
            c.innerHTML += `
            <div class="pizza-list-item">
                <span>üçï ${p.name.replace('PIZZA: ','')}</span>
                <button class="btn-del-pizza" onclick="delPizza(${i})">X</button>
            </div>`;
        });
    }
    window.delPizza = function(i) { cartPizze.splice(i,1); renderPizze(); calc(); }

    window.checkTavolo = function() {
        const show = document.getElementById('tipo').value === 'tavolo';
        const box = document.getElementById('box-tavolo');
        if(show) box.classList.remove('hidden'); else box.classList.add('hidden');
    }

    let totalValue = 0;
    function calc() {
        let cP=0, cS=0, cC=0, cI=0, cPiz=0;
        document.querySelectorAll('.stepper-val').forEach(el => {
            const q = parseInt(el.value) || 0;
            const t = el.dataset.type;
            if(t==='primo') cP += q;
            if(t==='secondo') cS += q;
            if(t==='contorno') cC += q;
            if(t==='insalatona') cI += q;
        });
        cPiz = cartPizze.length;

        let nCombo = Math.min(cP, cS, cC);
        let remP = cP - nCombo;
        let remS = cS - nCombo;
        let remC = cC - nCombo;

        totalValue = (nCombo * P.combo) + 
                     (remP * P.primi) + 
                     (remS * P.secondi) + 
                     (remC * P.contorni) + 
                     (cI * P.insalatone) + 
                     (cPiz * P.pizze);

        document.getElementById('view-total').innerText = "‚Ç¨ " + totalValue.toFixed(2).replace('.',',');
    }

    window.sendOrder = function() {
        if(isPanic) return;

        // --- CONTROLLO ORARIO (NUOVO) ---
        const now = new Date();
        const curMins = now.getHours() * 60 + now.getMinutes();
        const start = 9 * 60;        // 09:00
        const end = 23 * 60 + 15;    // 12:15 12 * 60 + 15

        if (curMins < start || curMins > end) {
            alert("‚ö†Ô∏è ATTENZIONE: Le ordinazioni sono aperte solo dalle 09:00 alle 12:15.");
            return;
        }
        // --------------------------------

        const nome = document.getElementById('nome').value.trim();
        const tel = document.getElementById('telefono').value.trim();
        const tipo = document.getElementById('tipo').value;
        const orario = document.getElementById('orario').value;
        const note = document.getElementById('note').value;

        if(!nome) return alert("Inserisci il nome");
        if(!tel) return alert("Inserisci il telefono");
        if(!orario) return alert("Scegli l'orario");

        let tableInfo = "N/A";
        let coperti = 0;
        if(tipo === 'tavolo') {
            const tName = document.getElementById('tavolo-nome').value.trim();
            const tPers = document.getElementById('tavolo-persone').value.trim();
            if(!tName || !tPers) return alert("Compila i dati del tavolo");
            tableInfo = tName.toUpperCase();
            coperti = parseInt(tPers);
        }

        let items = [];
        document.querySelectorAll('.stepper-val').forEach(el => {
            const q = parseInt(el.value);
            if(q > 0) items.push({ nome: el.dataset.name, qty: q });
        });
        cartPizze.forEach(p => items.push({ nome: p.name, qty: 1 }));

        if(items.length === 0) return alert("Carrello vuoto!");

        localStorage.setItem('user', nome);
        localStorage.setItem('phone', tel);

        const orderData = {
            cliente: nome, telefono: tel, tipo: tipo,
            tavolo: tableInfo, coperti: coperti,
            orario: orario, note: note,
            items: items, totale: totalValue,
            timestamp: Date.now()
        };

        if(confirm(`Confermi l'ordine di ‚Ç¨ ${totalValue.toFixed(2)}?`)) {
            const btn = document.getElementById('btn-invia');
            btn.disabled = true; btn.innerText = "Attendere...";
            window.onbeforeunload = null;

            db.ref('ordini').push(orderData)
            .then(() => {
                alert("Ordine Inviato con Successo! ‚úÖ");
                location.reload();
            })
            .catch(e => {
                alert("Errore: " + e.message);
                btn.disabled = false; btn.innerText = "INVIA ORDINE üöÄ";
            });
        }
    }
</script>
</body>
</html>

